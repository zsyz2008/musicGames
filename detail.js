!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([,function(e,t,n){const o=["#e05915","#cdd422","#431c5d","#bccbde","#c2dde6","#431c5d","#3cc47c","#76323f","#cdd422","#431c5d","#bccbde","#c2dde6"],r={flute:"flute",piano:"piano","lead 1 (square)":"flute","electric bass (finger)":"bass-electric","lead 2 (sawtooth)":"flute","overdriven guitar":"guitar-electric","string ensemble 1":"violin","orchestral harp":"piano","acoustic grand piano":"piano",vibraphone:"piano",trumpet:"trumpet","acoustic guitar (steel)":"guitar-acoustic","electric guitar (clean)":"guitar-electric","soprano sax":"saxophone","pad 2 (warm)":"violin","alto sax":"saxophone","electric guitar (jazz)":"guitar-electric","acoustic bass":"bass-electric","synth bass 1":"bass-electric","drawbar organ":"organ",piccolo:"flute",shamisen:"guitar-acoustic",xylophone:"xylophone","drawbar organ":"organ",shakuhachi:"clarinet","church organ":"organ",cello:"cello",harmonica:"harmonium",trombone:"trombone","muted trumpet":"trumpet",glockenspiel:"xylophone","bag pipe":"flute","pan flute":"flute",recorder:"organ",clarinet:"clarinet",whistle:"saxophone",accordion:"harmonium","string ensemble 2":"violin","slap bass 1":"bass-electric","electric piano 2":"piano",tuba:"tuba",oboe:"clarinet","french horn":"french-horn",bassoon:"bassoon","synthstrings 1":"violin","pizzicato strings":"piano",contrabass:"contrabass"},a=new Tone.Chorus(4,2.5,.5).toDestination().start();synth1=(new Tone.PolySynth).connect(a);const s=new Tone.Distortion(.8).toDestination();synth2=(new Tone.FMSynth).connect(s),synth3=new Tone.PolySynth(Tone.Synth,{envelope:{attack:.02,decay:.1,sustain:.3,release:1}}).toDestination();let i;i="//cdn.jsdelivr.net/gh/zsyz2008/musicGames/song/"+function(e){for(var t=window.location.search.substring(1).split("&"),n=0;n<t.length;n++){var o=t[n].split("=");if(o[0]==e)return o[1]}return!1}("name")+".json";const l=document.getElementById("scoreGroup");let c;function u(e){return new Promise((t,n)=>{let o;o="https://soundfont.s3.cn-north-1.jdcloud-oss.com/samples/"+e+"/";const r=new Tone.Sampler({urls:SampleLibrary[e],baseUrl:o,onload:e=>{t(r)}}).toDestination()})}fetch(i).then(e=>{if(200===e.status)return e.json();console.log("Looks like there was a problem. Status Code: "+e.status)}).then((function(e){c=e,document.getElementById("title").textContent=c.header.name;const t=c.header.timeSignatures[0].timeSignature[0],n=document.getElementById("scorePai");for(let e=0;e<t;e++){const o=document.createElement("div");o.boxSizing="content-box",o.setAttribute("class","list"),o.style.backgroundColor="#fff",e<t-1&&(o.style.borderRight="1px solid #db5a6b"),o.style.width=100/t+"%",o.textContent="第"+(e+1)+"拍",n.appendChild(o)}Array.prototype.slice.call(n.children),new Tone.Player("./samples/drum/normal-kick.wav").toDestination(),new Tone.Player("./samples/drum/snare.wav").toDestination(),new Tone.Player("./samples/drum/ch.wav").toDestination();return o=c,new Promise((e,t)=>{const n=60/+o.header.tempos[0].bpm*+o.header.timeSignatures[0].timeSignature[0],a={};let s=o.tracks;s=s.filter(e=>e.notes.length>0),s=s.filter(e=>"standard kit"!==e.instrument.name);const i=s.find(e=>-1!==e.instrument.name.indexOf("bass"));s=s.filter(e=>-1===e.instrument.name.indexOf("bass")),i&&s.push(i);const l=[];for(let e of s){const t=e.instrument.name;let n;r[t]?n=u(r[t]):(console.log(t),n=Promise.resolve(synth1)),l.push(n)}Promise.all(l).then(e=>e).then(t=>{s.forEach((e,n)=>{const o=t[n];e.notes.forEach(e=>{const t=e.time;let r,i=a[t];r=0===n?"solo":n===s.length-1?"bass":"zt";const l={type:r,name:e.name,duration:e.duration,velocity:+e.velocity*{solo:1,bass:.7,zt:.4}[r],synth:o,trackIndex:n};i?i.push(l):a[t]=[l]})});const o=[];let r=[],i=Object.keys(a).sort((function(e,t){return+e-+t}));for(let e of i)o.push(a[e]),r.push(e);const l=Math.ceil(r[r.length-1]/n),c={},u={};for(let e=0;e<l;e++){const t=[];for(let o=0;o<r.length;o++)r[o]<(e+1)*n&&r[o]>=e*n&&t.push({index:o,duration:r[o+1]-r[o]||1});const o=t[0]||"none";c[o.index]=t,u[o.index]=e}const d=s.length;e({notes:o,times:r,groupMap:c,groupValMap:u,trackLen:d})})});var o})).then(e=>{!function(e){const{playBtn:t,scoreContainer:n,mid:r,control:a}=e,{notes:s,times:i,groupMap:c,groupValMap:u,trackLen:d}=r;let p,h=0,f=0;function m(){f++;const e=c[h];if(e){l.textContent="第"+(+u[h]+1)+"小节",p=[],n.innerHTML="",f=0;const t=e.reduce((e,t)=>e+t.duration,0);for(let r=0;r<e.length;r++){const a=document.createElement("div"),i=e[r];a.setAttribute("class","list"),a.style.width=100*i.duration/t+"%";const l=s[i.index];for(let e=0;e<d;e++){const t=document.createElement("div");t.setAttribute("class","avatar");const n=100/d;t.style.height=n+"%",t.style.top=n*e+"%";l[e];const r=l.filter(t=>t.trackIndex===e);0===r.length&&(t.style.backgroundColor="#eee");for(let n=r.length-1;n>=0;n--){const a=r[n],s=document.createElement("div");s.setAttribute("class","fq"),s.style.height=100/r.length+"%",s.style.backgroundColor=o[e]||"#000",s.style.opacity=a.velocity,s.addEventListener("touchstart",e=>{g(a),e.preventDefault()}),t.appendChild(s)}a.appendChild(t)}n.appendChild(a),p.push(a)}}}function y(){a&&b&&b.forEach(e=>{e.synth.triggerRelease(e.name)})}function g(e){a?e.synth.triggerAttack(e.name,Tone.now(),e.velocity):e.synth.triggerAttackRelease(e.name,e.duration,Tone.now(),e.velocity)}document.getElementById("reset").addEventListener("click",()=>{h=0,f=0,m()}),m(),t.style.visibility="visible",t.addEventListener("touchstart",e=>{x(),e.preventDefault()}),t.addEventListener("touchend",e=>{y()}),t.addEventListener("mousedown",e=>{x(),e.preventDefault()}),t.addEventListener("mouseup",e=>{y()}),window.addEventListener("keydown",e=>{x()}),window.addEventListener("keyup",e=>{y()});let b,v,w;function x(){y();const e=s[h];b=e,e.forEach(e=>{g(e)}),function(){if(p&&p[f])for(let e of Array.prototype.slice.call(p[f].children))e.style.width="0%";m(),clearInterval(v),w||console.log("抢拍子了");w=!1;const e=p[f];if(!e)return;const t=i[h],n=i[h+1];let o;o=n?1e3*(n-t):3e3;let r,a=Date.now();v=setInterval(()=>{if(r<=0){s[h];clearInterval(v),r=0;for(let t of Array.prototype.slice.call(e.children))t.style.width="0%";return void(w=!0)}r=o-(Date.now()-a);const t=Math.ceil(100*r/o);for(let n of Array.prototype.slice.call(e.children))n.style.width=t+"%"},30)}(),h===s.length-1?h=0:h++}}({playBtn:document.getElementById("playBtn"),scoreContainer:document.getElementById("scoreContainer"),mid:e,control:!1})}),window.onload=function(){Tone.context.resume().then(()=>{Tone.Transport.start(),Tone.getContext().lookAhead=0,Tone.Transport.bpm.value=50})}}]);