!function(e){var t={};function o(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,o),a.l=!0,a.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)o.d(n,a,function(t){return e[t]}.bind(null,a));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=1)}([,function(e,t,o){const n={flute:"flute","lead 1 (square)":"lead_1_square","lead 5 (charang)":"lead_5_charang","electric bass (finger)":"electric_bass_finger","fretless bass":"fretless_bass","slap bass 1":"slap_bass_1","synth bass 1":"synth_bass_1","synthbrass 2":"synth_brass_2","fx 3 (crystal)":"fx_3_crystal","lead 2 (sawtooth)":"lead_2_sawtooth","overdriven guitar":"overdriven_guitar","string ensemble 1":"string_ensemble_1","orchestral harp":"orchestral_harp","acoustic grand piano":"acoustic_grand_piano","bright acoustic piano":"bright_acoustic_piano",vibraphone:"vibraphone",trumpet:"trumpet","acoustic guitar (steel)":"acoustic_guitar_steel","electric guitar (clean)":"electric_guitar_clean","soprano sax":"soprano_sax","tenor sax":"tenor_sax","pad 2 (warm)":"pad_2_warm","alto sax":"alto_sax","electric guitar (jazz)":"electric_guitar_jazz","acoustic bass":"acoustic_bass","synth bass 1":"synth_bass_1","drawbar organ":"drawbar_organ",piccolo:"piccolo",shamisen:"shamisen",xylophone:"xylophone",shakuhachi:"shakuhachi","church organ":"church_organ",cello:"cello",harmonica:"harmonica",trombone:"trombone","muted trumpet":"muted_trumpet",glockenspiel:"glockenspiel","bag pipe":"bagpipe","pan flute":"pan_flute",recorder:"recorder",clarinet:"clarinet",whistle:"whistle",accordion:"accordion","string ensemble 2":"string_ensemble_2","slap bass 1":"slap_bass_1","electric piano 2":"electric_piano_2",tuba:"tuba",oboe:"oboe","english horn":"english_horn","french horn":"french_horn",bassoon:"bassoon","synthstrings 1":"synth_strings_1","pizzicato strings":"pizzicato_strings",contrabass:"contrabass","acoustic guitar (nylon)":"acoustic_guitar_nylon","electric guitar (muted)":"electric_guitar_muted","distortion guitar":"distortion_guitar",timpani:"timpani",koto:"koto",ocarina:"ocarina","electric bass (pick)":"electric_bass_pick","music box":"music_box","electric piano 1":"electric_piano_1","brass section":"brass_section","synth drum":"synth_drum","standard kit":"synth_drum","jazz kit":"synth_drum","brush kit":"synth_drum","electronic kit":"synth_drum","tr-808 kit":"synth_drum",gunshot:"gunshot","synthbrass 1":"synth_brass_1","lead 8 bass":"lead_8_bass__lead","tubular bells":"tubular_bells",harpsichord:"harpsichord",violin:"violin",viola:"viola",marimba:"marimba","pad 8 (sweep)":"pad_8_sweep","pad 1 (new age)":"pad_1_new_age","fx 4 (atmosphere)":"fx_4_atmosphere","synthstrings 2":"synth_strings_2","power kit":"synth_drum",celesta:"celesta","lead 8 (bass + lead)":"lead_8_bass__lead","synth bass 2":"synth_bass_2",clavi:"clavinet","choir aahs":"choir_aahs","guitar fret noise":"guitar_fret_noise","synth voice":"synth_choir","rock organ":"rock_organ","percussive organ":"percussive_organ","fx 2 (soundtrack)":"fx_2_soundtrack","pad 3 (polysynth)":"\tpad_3_polysynth",sitar:"sitar","voice oohs":"voice_oohs","orchestra hit":"orchestra_hit","guitar harmonics":"guitar_harmonics","reverse cymbal":"reverse_cymbal","baritone sax":"baritone_sax","pad 4 (choir)":"pad_4_choir",kalimba:"kalimba","fx 5 (brightness)":"fx_5_brightness","telephone ring":"telephone_ring","electric grand piano":"electric_grand_piano","melodic tom":"melodic_tom","taiko drum":"taiko_drum","honky-tonk piano":"honkytonk_piano","tinkle bell":"tinkle_bell",applause:"applause",woodblock:"woodblock","lead 3 (calliope)":"lead_3_calliope","fx 1 (rain)":"fx_1_rain","lead 6 (voice)":"lead_6_voice","fx 7 (echoes)":"fx_7_echoes","bird tweet":"bird_tweet",helicopter:"helicopter",seashore:"seashore","pad 7 (halo)":"pad_7_halo","pad 6 (metallic)":"pad_6_metallic",banjo:"banjo","slap bass 2":"slap_bass_2","tremolo strings":"tremolo_strings","orchestra kit":"orchestra_hit"},a="true"===f("computer"),s={all:{A7:"A7.[mp3|ogg]",A1:"A1.[mp3|ogg]",A2:"A2.[mp3|ogg]",A3:"A3.[mp3|ogg]",A4:"A4.[mp3|ogg]",A5:"A5.[mp3|ogg]",A6:"A6.[mp3|ogg]","A#7":"Bb7.[mp3|ogg]","A#1":"Bb1.[mp3|ogg]","A#2":"Bb2.[mp3|ogg]","A#3":"Bb3.[mp3|ogg]","A#4":"Bb4.[mp3|ogg]","A#5":"Bb5.[mp3|ogg]","A#6":"Bb6.[mp3|ogg]",B7:"B7.[mp3|ogg]",B1:"B1.[mp3|ogg]",B2:"B2.[mp3|ogg]",B3:"B3.[mp3|ogg]",B4:"B4.[mp3|ogg]",B5:"B5.[mp3|ogg]",B6:"B6.[mp3|ogg]",C7:"C7.[mp3|ogg]",C1:"C1.[mp3|ogg]",C2:"C2.[mp3|ogg]",C3:"C3.[mp3|ogg]",C4:"C4.[mp3|ogg]",C5:"C5.[mp3|ogg]",C6:"C6.[mp3|ogg]","C#7":"Db7.[mp3|ogg]","C#1":"Db1.[mp3|ogg]","C#2":"Db2.[mp3|ogg]","C#3":"Db3.[mp3|ogg]","C#4":"Db4.[mp3|ogg]","C#5":"Db5.[mp3|ogg]","C#6":"Db6.[mp3|ogg]",D7:"D7.[mp3|ogg]",D1:"D1.[mp3|ogg]",D2:"D2.[mp3|ogg]",D3:"D3.[mp3|ogg]",D4:"D4.[mp3|ogg]",D5:"D5.[mp3|ogg]",D6:"D6.[mp3|ogg]","D#7":"Eb7.[mp3|ogg]","D#1":"Eb1.[mp3|ogg]","D#2":"Eb2.[mp3|ogg]","D#3":"Eb3.[mp3|ogg]","D#4":"Eb4.[mp3|ogg]","D#5":"Eb5.[mp3|ogg]","D#6":"Eb6.[mp3|ogg]",E7:"E7.[mp3|ogg]",E1:"E1.[mp3|ogg]",E2:"E2.[mp3|ogg]",E3:"E3.[mp3|ogg]",E4:"E4.[mp3|ogg]",E5:"E5.[mp3|ogg]",E6:"E6.[mp3|ogg]",F7:"F7.[mp3|ogg]",F1:"F1.[mp3|ogg]",F2:"F2.[mp3|ogg]",F3:"F3.[mp3|ogg]",F4:"F4.[mp3|ogg]",F5:"F5.[mp3|ogg]",F6:"F6.[mp3|ogg]","F#7":"Gb7.[mp3|ogg]","F#1":"Gb1.[mp3|ogg]","F#2":"Gb2.[mp3|ogg]","F#3":"Gb3.[mp3|ogg]","F#4":"Gb4.[mp3|ogg]","F#5":"Gb5.[mp3|ogg]","F#6":"Gb6.[mp3|ogg]",G7:"G7.[mp3|ogg]",G1:"G1.[mp3|ogg]",G2:"G2.[mp3|ogg]",G3:"G3.[mp3|ogg]",G4:"G4.[mp3|ogg]",G5:"G5.[mp3|ogg]",G6:"G6.[mp3|ogg]","G#7":"Ab7.[mp3|ogg]","G#1":"Ab1.[mp3|ogg]","G#2":"Ab2.[mp3|ogg]","G#3":"Ab3.[mp3|ogg]","G#4":"Ab4.[mp3|ogg]","G#5":"Ab5.[mp3|ogg]","G#6":"Ab6.[mp3|ogg]"}},r={},i=new Tone.Chorus(4,2.5,.5).toDestination().start();synth1=(new Tone.PolySynth).connect(i);const c=f("name"),g=f("track"),l=document.getElementById("scoreInfo");let m,u,d;m="https://soundfont.s3-accelerate.cn-north-1.jdcloud-oss.com/json/"+c+".json?t="+(new Date).getTime(),u="https://soundfont.s3-accelerate.cn-north-1.jdcloud-oss.com/mp3/"+c+".mp3?t="+(new Date).getTime(),console.log(u,222),!0===a&&(d=new Tone.Player(u,()=>{console.log("MP3 文件加载完成！")}));document.getElementById("scoreGroup");let h,_;function b(e){return new Promise((t,o)=>{let n;n="https://soundfont.s3-accelerate.cn-north-1.jdcloud-oss.com/FatBoy/"+e+"-mp3/";const a=new Tone.Sampler({urls:r[e],baseUrl:n,onload:e=>{t(a)}}).toDestination()})}function f(e){for(var t=window.location.search.substring(1).split("&"),o=0;o<t.length;o++){var n=t[o].split("=");if(n[0]==e)return n[1]}return!1}fetch(m).then(e=>{if(200===e.status)return l.innerHTML="加载音色中：0%",e.json();console.log("Looks like there was a problem. Status Code: "+e.status)}).then((function(e){_=e,h=_.header.name||"无名",l.innerHTML=h;const t=_.header.timeSignatures[0].timeSignature[0],o=(_.header.timeSignatures[0].timeSignature[1],document.getElementById("scorePai"));for(let e=0;e<t;e++){const n=document.createElement("div");n.boxSizing="content-box",n.setAttribute("class","list"),e<t-1&&(n.style.borderRight=".5px solid rgba(240, 96, 29, .6)"),n.style.width=100/t+"%",o.appendChild(n)}return i=_,new Promise((e,t)=>{const o=+i.header.tempos[0].bpm,c=+i.header.timeSignatures[0].timeSignature[0],m=+i.header.timeSignatures[0].timeSignature[1]/1,u=i.header.keySignatures[0]?i.header.keySignatures[0].key:"C",d=4*c/m*(60/o),_={};let f=i.tracks;if(f=f.filter(e=>e.notes.length>0),console.log(f,"音轨"),g){const e=g.split(",");console.log(e,33),f=f.filter((t,o)=>-1!==e.indexOf(String(o)))}console.log(f,"音轨新");for(let e of f){const t=n[e.instrument.name],o=[...new Set(e.notes.map(e=>e.name))];r[t]?r[t]=[...new Set(r[t].concat(o))]:r[t]=o}Object.keys(r).forEach(e=>{const t={};r[e].forEach(e=>{const o=s.all[e];o&&(t[e]=o)}),r[e]=t});const y=[],v={};for(let e of f){const t=e.instrument.name;if(v[t])y.push(v[t]);else{if(n[t])try{p=b(n[t]),console.log(t,"音色")}catch(e){console.log(e,"load error"),p=Promise.resolve(synth1)}else console.log(t,"音源不存在"),p=Promise.resolve(synth1);v[t]=p,y.push(p)}}(function(e,t){let o=0;return e.forEach(n=>{n.then(()=>{o++;const n=100*o/e.length;t(n)})}),Promise.all(e)})(y,(function(e){l.innerHTML="加载音色中："+Math.ceil(e)+"%"})).then(t=>{l.innerHTML=h;const o={},n={},s={};f.forEach((e,r)=>{const i=t[r];let c=e.notes;n[e.instrument.name]=!0,s[e.instrument.family]=!0;const g="drums"===e.instrument.family;c.forEach(t=>{const n=t.time;let s,c=_[n];0===r?(s="solo",o.solo=!0):r===f.length-1&&-1!==e.instrument.name.indexOf(" bass")?(s="bass",o.bass=!0):g?(s="drum",o.drum=!0):(s="zt",o.zt=!0);const l={type:s,instrument:e.instrument.name,instrument_family:e.instrument.family,name:t.name,duration:t.duration,velocity:!0===a?0:+t.velocity*{solo:1,bass:1,zt:1,drum:1}[s],synth:i,trackIndex:r};c?c.push(l):_[n]=[l]})}),[].concat(Object.keys(n));const r=[];let i=[],c=Object.keys(_).sort((function(e,t){return+e-+t}));for(let e of c)r.push(_[e]),i.push(e);const g=Math.ceil(i[i.length-1]/d),p={},m={},b={};for(let e=0;e<g;e++){const t=[];for(let o=0;o<i.length;o++)i[o]<(e+1)*d&&i[o]>=e*d&&(t.push({index:o,duration:i[o+1]-i[o]||1}),b[o]=t[0].index);const o=t[0]||"none";p[o.index]=t,m[o.index]=e}const y=f.length;e({notes:r,times:i,groupMap:p,groupValMap:m,trackLen:y,indexToGroupMap:b,keySignatures:u})})});var i})).then(e=>{!function(e){const{playBtn:t,scoreContainer:o,mid:n}=e,{notes:s,times:r,groupMap:i,groupValMap:c,indexToGroupMap:g,trackLen:l}=n;let p,m=0,u=-1,h=!1;o.addEventListener("touchstart",e=>{e.preventDefault()});const _=document.getElementById("pre");_&&_.addEventListener("click",()=>{const e=g[m-1];void 0!==e&&(m=e,u=-1)});const b=document.getElementById("next");b&&b.addEventListener("click",()=>{if(void 0===g[m])return;const e=i[g[m]],t=g[e[e.length-1].index+1];void 0!==t&&(m=t,u=-1)});document.getElementById("gameContiner");t.style.visibility="visible";let f=!0;const y=document.getElementById("startBtn");function v(){!h&&k&&k.forEach(e=>{e.synth.triggerRelease(e.name)}),p&&p[u]&&(p[u].style.opacity=0)}var k;function x(){!h&&k&&k.forEach(e=>{e.synth.triggerRelease(e.name)});const e=s[m];k=e,e.forEach(e=>{!function(e){h?e.synth.triggerAttackRelease(e.name,e.duration,Tone.now(),e.velocity):e.synth.triggerAttack(e.name,Tone.now(),e.velocity)}(e)}),h||p&&p[u]&&(p[u].style.opacity=1),m===s.length-1?(m=0,!1===h?w():h=!1):m++}t.addEventListener("touchstart",e=>{e.currentTarget.classList.add("active"),f||h||(x(),e.preventDefault())}),t.addEventListener("touchend",e=>{if(e.currentTarget.classList.remove("active"),f)return y.style.display="none",f=!1,!0===a&&(d.toDestination(),d.start()),void w();h||v()}),t.addEventListener("mousedown",e=>{e.currentTarget.classList.add("active"),f||h||(e.currentTarget.classList.add("active"),x(),e.preventDefault())}),t.addEventListener("mouseup",e=>{if(e.currentTarget.classList.remove("active"),f)return y.style.display="none",f=!1,void w();h||v()});const E=[];function w(){console.log("autoplay"),h=!0,r.forEach((e,o)=>{const n=setTimeout(()=>{x();const e=(r[o+1]||0)-r[o];let a=s[o].map(e=>e.duration),i=Math.max(...a);i=Math.min(i,e),i=Math.max(i,.2),t.style.transitionDuration=i+"s",t.classList.contains("active")?t.classList.remove("active"):t.classList.add("active"),clearTimeout(n),E.pop()},1e3*e);E.push(n)})}}({playBtn:document.getElementById("playBtn"),scoreContainer:document.getElementById("scoreContainer"),mid:e})}),window.onload=function(){Tone.context.resume().then(()=>{Tone.Transport.start(),Tone.getContext().lookAhead=0})}}]);