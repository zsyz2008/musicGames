!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([,function(e,t,n){window.onerror=function(e,t,n){return alert(e),!1};Vex.Flow;const o=document.getElementById("mystaff"),{Stave:r,StaveNote:a,Beam:s,Formatter:i,Renderer:c,Accidental:l,AccidentalManager:u,Voice:d}=Vex.Flow;console.log(u,555);const h={flute:"flute",piano:"piano","lead 1 (square)":"flute","electric bass (finger)":"bass-electric","fretless bass":"bass-electric","synthbrass 2":"french-horn","fx 3 (crystal)":"xylophone","lead 2 (sawtooth)":"flute","overdriven guitar":"guitar-electric","string ensemble 1":"violin","orchestral harp":"harp","acoustic grand piano":"piano","bright acoustic piano":"piano",vibraphone:"piano",trumpet:"trumpet","acoustic guitar (steel)":"guitar-acoustic","electric guitar (clean)":"guitar-electric","soprano sax":"saxophone","tenor sax":"saxophone","pad 2 (warm)":"violin","alto sax":"saxophone","electric guitar (jazz)":"guitar-electric","acoustic bass":"bass-electric","synth bass 1":"bass-electric","drawbar organ":"organ",piccolo:"flute",shamisen:"guitar-acoustic",xylophone:"xylophone","drawbar organ":"organ",shakuhachi:"clarinet","church organ":"organ",cello:"cello",harmonica:"harmonium",trombone:"trombone","muted trumpet":"trumpet",glockenspiel:"xylophone","bag pipe":"flute","pan flute":"flute",recorder:"organ",clarinet:"clarinet",whistle:"saxophone",accordion:"harmonium","string ensemble 2":"violin","slap bass 1":"bass-electric","electric piano 2":"piano",tuba:"tuba",oboe:"clarinet","english horn":"bassoon","french horn":"french-horn",bassoon:"bassoon","synthstrings 1":"violin","pizzicato strings":"harp",contrabass:"contrabass","acoustic guitar (nylon)":"guitar-nylon"},p=new Tone.Chorus(4,2.5,.5).toDestination().start();synth1=(new Tone.PolySynth).connect(p);const f=new Tone.Distortion(.8).toDestination();synth2=(new Tone.FMSynth).connect(f),synth3=new Tone.PolySynth(Tone.Synth,{envelope:{attack:.02,decay:.1,sustain:.3,release:1}}).toDestination();const m=w("name"),g=w("track");let y;y="//cdn.jsdelivr.net/gh/zsyz2008/musicGames/song/"+m+".json";const b=document.getElementById("scoreGroup");let v;function w(e){for(var t=window.location.search.substring(1).split("&"),n=0;n<t.length;n++){var o=t[n].split("=");if(o[0]==e)return o[1]}return!1}fetch(y).then(e=>{if(200===e.status)return scoreContainer.innerHTML="加载音色中：0%",e.json();console.log("Looks like there was a problem. Status Code: "+e.status)}).then((function(e){v=e,document.getElementById("title").textContent=v.header.name;const t=v.header.timeSignatures[0].timeSignature[0],n=(v.header.timeSignatures[0].timeSignature[1],document.getElementById("scorePai"));for(let e=0;e<t;e++){const o=document.createElement("div");o.boxSizing="content-box",o.setAttribute("class","list"),e<t-1&&(o.style.borderRight="1px solid #db5a6b"),o.style.width=100/t+"%",o.textContent=e+1,n.appendChild(o)}return o=v,new Promise((e,t)=>{const n=+o.header.tempos[0].bpm,r=+o.header.timeSignatures[0].timeSignature[0],a=+o.header.timeSignatures[0].timeSignature[1]/1,s=o.header.keySignatures[0]?o.header.keySignatures[0].key:"C",i=4*r/a*(60/n),c={};let l=o.tracks;l=l.filter(e=>e.notes.length>0),l=l.filter(e=>"standard kit"!==e.instrument.name&&"jazz kit"!==e.instrument.name&&"brush kit"!==e.instrument.name);const u=l.find(e=>-1!==e.instrument.name.indexOf(" bass"));l=l.filter(e=>-1===e.instrument.name.indexOf(" bass")),u&&l.push(u),"solo"===g&&(l=l.filter((e,t)=>0===t)),"bz"===g&&(l=l.filter((e,t)=>0!==t));const d=[];for(let e of l){const t=e.instrument.name;let n;h[t]?n=Promise.resolve(synth3):(console.log(t),n=Promise.resolve(synth1)),d.push(n)}(function(e,t){let n=0;return e.forEach(o=>{o.then(()=>{n++;const o=100*n/e.length;t(o)})}),Promise.all(e)})(d,(function(e){scoreContainer.innerHTML="加载音色中："+Math.ceil(e)+"%"})).then(t=>{l.forEach((e,n)=>{const o=t[n];e.notes.forEach(t=>{const r=t.time;let a,s=c[r];a=0===n?"solo":n===l.length-1&&-1!==e.instrument.name.indexOf(" bass")?"bass":"zt";const i={type:a,name:t.name,duration:t.duration,velocity:+t.velocity*{solo:1,bass:1,zt:.4}[a],synth:o,trackIndex:n};s?s.push(i):c[r]=[i]})});const n=[];let o=[],r=Object.keys(c).sort((function(e,t){return+e-+t}));for(let e of r)n.push(c[e]),o.push(e);const a=Math.ceil(o[o.length-1]/i),u={},d={},h={};for(let e=0;e<a;e++){const t=[];for(let n=0;n<o.length;n++)o[n]<(e+1)*i&&o[n]>=e*i&&(t.push({index:n,duration:o[n+1]-o[n]||1}),h[n]=t[0].index);const n=t[0]||"none";u[n.index]=t,d[n.index]=e}const p=l.length;e({notes:n,times:o,groupMap:u,groupValMap:d,trackLen:p,indexToGroupMap:h,keySignatures:s})})});var o})).then(e=>{!function(e){const{playBtn:t,scoreContainer:n,mid:s}=e,{notes:u,times:h,groupMap:p,groupValMap:f,indexToGroupMap:m,trackLen:g}=s;let y,v=0,w=-1,x=!1;document.getElementById("control").addEventListener("change",(function(e){x=!!e.target.checked})),n.addEventListener("touchstart",e=>{e.preventDefault()});const k=document.getElementById("staff"),S=document.getElementById("staffDiv");k.addEventListener("change",(function(e){e.target.checked?S.style.visibility="visible":S.style.visibility="hidden"}));const M=document.getElementById("reset");function T(){w++;const e=p[v];if(e){if(1===w)return void(w=0);!function(e){const{keySignatures:t}=s;o.innerHTML="";const n=new c(o,c.Backends.SVG),u=document.body.clientWidth;n.resize(u,320);const h=n.getContext(),p=new r(10,50,u-20).addKeySignature(t);p.addClef("treble").setContext(h).draw(),console.log(e,23);const f=[],m=[];for(let t of e){let e=[],n=[];for(let o of t){let t=o.name;var g=t.slice(-1),y=t.slice(0,-1)+"/"+g;+o.name.slice(t.length-1)>3?e.push(y):n.push(y)}e=[...new Set(e)],n=[...new Set(n)],f.push({ups:e}),m.push({downs:n})}const b=f.map(e=>{let t;return e.ups.length>0?(t=new a({keys:e.ups,duration:"q"}),console.log(e,23)):t=new a({keys:["B/4"],duration:"qr"}),t.autoStem(),t}),v=(new d).setMode(d.Mode.SOFT).addTickables(b);l.applyAccidentals([v],t),i.FormatAndDraw(h,p,b);const w=new r(10,150,u-20).addKeySignature(t);w.addClef("bass").setContext(h).draw();const x=m.map(e=>{let t;return t=e.downs.length>0?new a({keys:e.downs,duration:"q",stem_direction:-1,clef:"bass"}):new a({keys:["D/3"],duration:"qr",stem_direction:-1,clef:"bass"}),t.autoStem(),t}),k=(new d).setMode(d.Mode.SOFT).addTickables(x);l.applyAccidentals([k],t),i.FormatAndDraw(h,w,x)}(e.map(e=>u[e.index])),b.textContent="第"+(+f[v]+1)+"小节",y=[],n.innerHTML="",w=0;const t=e.reduce((e,t)=>e+t.duration,0);for(let o=0;o<e.length;o++){const r=document.createElement("button"),a=e[o];r.setAttribute("class","list button2 fire"),r.style.opacity=.3,r.style.width=100*a.duration/t+"%",0===o&&B(r),n.appendChild(r),y.push(r)}}}if(M&&M.addEventListener("click",()=>{v=m[v-1],w=0,T()}),T(),window.addEventListener("keydown",e=>{O()}),window.addEventListener("keyup",e=>{L()}),!navigator.requestMIDIAccess)return void console.log("当前浏览器不支持 MIDI 连接，请使用 Chrome 等支持 Web MIDI 的浏览器");let E=[];const I=e=>{const t=`${e.note.name}${e.note.accidental?e.note.accidental:""}${e.note.octave}`;E.push(Tone.Frequency(t).toMidi());const n=u[v].map(e=>Tone.Frequency(e.name).toMidi());let o=!0;for(let e of n)E.includes(e)||(o=!1);o&&O()},C=()=>{E=[]};function D(e){e&&e.preventDefault(),O()}function L(){var e;x&&j&&j.forEach(e=>{e.synth.triggerRelease(e.name)}),y&&y[w]&&(e=y[w])&&e.removeEventListener("touchstart",D)}function B(e){e&&(e.style.opacity=1,e.addEventListener("touchstart",D))}var j,z;function O(){x&&j&&j.forEach(e=>{e.synth.triggerRelease(e.name)});u[v+1];const e=u[v];j=e,e.forEach(e=>{!function(e){x?e.synth.triggerAttack(e.name,Tone.now(),e.velocity):e.synth.triggerAttackRelease(e.name,e.duration,Tone.now(),e.velocity)}(e)}),function(){T(),clearInterval(z);const e=y[w];if(!e)return;const t=h[v],n=h[v+1];let o;o=n?1e3*(n-t):3e3;let r,a=Date.now();z=setInterval(()=>{if(r<100)return clearInterval(z),r=0,e.style.opacity=0,B(y[w+1]),void(w===y.length-1&&(w=-1,T()));r=o-(Date.now()-a);const t=Math.ceil(100*r/o);e.style.opacity=t/100},10)}(),v===u.length-1?v=0:v++,L()}WebMidi.enable(()=>{if(0===WebMidi.inputs.length)return void console.log("没有找到可连接的 MIDI 设备，请检查 MIDI 设备是否正确连接");const e=WebMidi.inputs[0];e.addListener("noteon","all",I),e.addListener("noteoff","all",C)})}({playBtn:document.getElementById("playBtn"),scoreContainer:document.getElementById("scoreContainer"),mid:e})}),window.onload=function(){Tone.context.resume().then(()=>{Tone.Transport.start(),Tone.getContext().lookAhead=0,Tone.Transport.bpm.value=50})}}]);