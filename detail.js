!function(g){var o={};function e(t){if(o[t])return o[t].exports;var p=o[t]={i:t,l:!1,exports:{}};return g[t].call(p.exports,p,p.exports,e),p.l=!0,p.exports}e.m=g,e.c=o,e.d=function(g,o,t){e.o(g,o)||Object.defineProperty(g,o,{enumerable:!0,get:t})},e.r=function(g){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(g,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(g,"__esModule",{value:!0})},e.t=function(g,o){if(1&o&&(g=e(g)),8&o)return g;if(4&o&&"object"==typeof g&&g&&g.__esModule)return g;var t=Object.create(null);if(e.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:g}),2&o&&"string"!=typeof g)for(var p in g)e.d(t,p,function(o){return g[o]}.bind(null,p));return t},e.n=function(g){var o=g&&g.__esModule?function(){return g.default}:function(){return g};return e.d(o,"a",o),o},e.o=function(g,o){return Object.prototype.hasOwnProperty.call(g,o)},e.p="",e(e.s=1)}([,function(g,o,e){window.onerror=function(g,o,e){return alert(g),!1};Vex.Flow;const t=document.getElementById("mystaff"),{Stave:p,StaveNote:m,Beam:n,Formatter:s,Renderer:r,Accidental:a,AccidentalManager:i,Voice:c}=Vex.Flow;console.log(i,555);const l={flute:"flute",piano:"piano","lead 1 (square)":"flute","electric bass (finger)":"bass-electric","fretless bass":"bass-electric","synthbrass 2":"french-horn","fx 3 (crystal)":"xylophone","lead 2 (sawtooth)":"flute","overdriven guitar":"guitar-electric","string ensemble 1":"violin","orchestral harp":"harp","acoustic grand piano":"piano","bright acoustic piano":"piano",vibraphone:"piano",trumpet:"trumpet","acoustic guitar (steel)":"guitar-acoustic","electric guitar (clean)":"guitar-electric","soprano sax":"saxophone","tenor sax":"saxophone","pad 2 (warm)":"violin","alto sax":"saxophone","electric guitar (jazz)":"guitar-electric","acoustic bass":"bass-electric","synth bass 1":"bass-electric","drawbar organ":"organ",piccolo:"flute",shamisen:"guitar-acoustic",xylophone:"xylophone","drawbar organ":"organ",shakuhachi:"clarinet","church organ":"organ",cello:"cello",harmonica:"harmonium",trombone:"trombone","muted trumpet":"trumpet",glockenspiel:"xylophone","bag pipe":"flute","pan flute":"flute",recorder:"organ",clarinet:"clarinet",whistle:"saxophone",accordion:"harmonium","string ensemble 2":"violin","slap bass 1":"bass-electric","electric piano 2":"piano",tuba:"tuba",oboe:"clarinet","english horn":"bassoon","french horn":"french-horn",bassoon:"bassoon","synthstrings 1":"violin","pizzicato strings":"harp",contrabass:"contrabass","acoustic guitar (nylon)":"guitar-nylon"},u={"bass-electric":{"A#1":"As1.[mp3|ogg]","A#2":"As2.[mp3|ogg]","A#3":"As3.[mp3|ogg]","A#4":"As4.[mp3|ogg]","C#1":"Cs1.[mp3|ogg]","C#2":"Cs2.[mp3|ogg]","C#3":"Cs3.[mp3|ogg]","C#4":"Cs4.[mp3|ogg]",E1:"E1.[mp3|ogg]",E2:"E2.[mp3|ogg]",E3:"E3.[mp3|ogg]",E4:"E4.[mp3|ogg]",G1:"G1.[mp3|ogg]",G2:"G2.[mp3|ogg]",G3:"G3.[mp3|ogg]",G4:"G4.[mp3|ogg]"},"bass-acoustic":{"A#1":"Bb1.[mp3|ogg]","A#2":"Bb2.[mp3|ogg]","A#3":"Bb3.[mp3|ogg]","A#4":"Bb4.[mp3|ogg]","C#1":"Db1.[mp3|ogg]","C#2":"Db2.[mp3|ogg]","C#3":"Db3.[mp3|ogg]","C#4":"Db4.[mp3|ogg]",E1:"E1.[mp3|ogg]",E2:"E2.[mp3|ogg]",E3:"E3.[mp3|ogg]",E4:"E4.[mp3|ogg]",G1:"G1.[mp3|ogg]",G2:"G2.[mp3|ogg]",G3:"G3.[mp3|ogg]",G4:"G4.[mp3|ogg]"},bassoon:{A4:"A4.[mp3|ogg]",C3:"C3.[mp3|ogg]",C4:"C4.[mp3|ogg]",C5:"C5.[mp3|ogg]",E4:"E4.[mp3|ogg]",G2:"G2.[mp3|ogg]",G3:"G3.[mp3|ogg]",G4:"G4.[mp3|ogg]",A2:"A2.[mp3|ogg]",A3:"A3.[mp3|ogg]"},cello:{E3:"E3.[mp3|ogg]",E4:"E4.[mp3|ogg]",F2:"F2.[mp3|ogg]",F3:"F3.[mp3|ogg]",F4:"F4.[mp3|ogg]","F#3":"Fs3.[mp3|ogg]","F#4":"Fs4.[mp3|ogg]",G2:"G2.[mp3|ogg]",G3:"G3.[mp3|ogg]",G4:"G4.[mp3|ogg]","G#2":"Gs2.[mp3|ogg]","G#3":"Gs3.[mp3|ogg]","G#4":"Gs4.[mp3|ogg]",A2:"A2.[mp3|ogg]",A3:"A3.[mp3|ogg]",A4:"A4.[mp3|ogg]","A#2":"As2.[mp3|ogg]","A#3":"As3.[mp3|ogg]",B2:"B2.[mp3|ogg]",B3:"B3.[mp3|ogg]",B4:"B4.[mp3|ogg]",C2:"C2.[mp3|ogg]",C3:"C3.[mp3|ogg]",C4:"C4.[mp3|ogg]",C5:"C5.[mp3|ogg]","C#3":"Cs3.[mp3|ogg]","C#4":"Cs4.[mp3|ogg]",D2:"D2.[mp3|ogg]",D3:"D3.[mp3|ogg]",D4:"D4.[mp3|ogg]","D#2":"Ds2.[mp3|ogg]","D#3":"Ds3.[mp3|ogg]","D#4":"Ds4.[mp3|ogg]",E2:"E2.[mp3|ogg]"},clarinet:{D4:"D4.[mp3|ogg]",D5:"D5.[mp3|ogg]",D6:"D6.[mp3|ogg]",F3:"F3.[mp3|ogg]",F4:"F4.[mp3|ogg]",F5:"F5.[mp3|ogg]","F#6":"Fs6.[mp3|ogg]","A#3":"As3.[mp3|ogg]","A#4":"As4.[mp3|ogg]","A#5":"As5.[mp3|ogg]",D3:"D3.[mp3|ogg]"},contrabass:{C2:"C2.[mp3|ogg]","C#3":"Cs3.[mp3|ogg]",D2:"D2.[mp3|ogg]",E2:"E2.[mp3|ogg]",E3:"E3.[mp3|ogg]","F#1":"Fs1.[mp3|ogg]","F#2":"Fs2.[mp3|ogg]",G1:"G1.[mp3|ogg]","G#2":"Gs2.[mp3|ogg]","G#3":"Gs3.[mp3|ogg]",A2:"A2.[mp3|ogg]","A#1":"As1.[mp3|ogg]",B3:"B3.[mp3|ogg]"},flute:{A6:"A6.[mp3|ogg]",C4:"C4.[mp3|ogg]",C5:"C5.[mp3|ogg]",C6:"C6.[mp3|ogg]",C7:"C7.[mp3|ogg]",E4:"E4.[mp3|ogg]",E5:"E5.[mp3|ogg]",E6:"E6.[mp3|ogg]",A4:"A4.[mp3|ogg]",A5:"A5.[mp3|ogg]"},"french-horn":{D3:"D3.[mp3|ogg]",D5:"D5.[mp3|ogg]","D#2":"Ds2.[mp3|ogg]",F3:"F3.[mp3|ogg]",F5:"F5.[mp3|ogg]",G2:"G2.[mp3|ogg]",A1:"A1.[mp3|ogg]",A3:"A3.[mp3|ogg]",C2:"C2.[mp3|ogg]",C4:"C4.[mp3|ogg]"},"guitar-acoustic":{F4:"F4.[mp3|ogg]","F#2":"Fs2.[mp3|ogg]","F#3":"Fs3.[mp3|ogg]","F#4":"Fs4.[mp3|ogg]",G2:"G2.[mp3|ogg]",G3:"G3.[mp3|ogg]",G4:"G4.[mp3|ogg]","G#2":"Gs2.[mp3|ogg]","G#3":"Gs3.[mp3|ogg]","G#4":"Gs4.[mp3|ogg]",A2:"A2.[mp3|ogg]",A3:"A3.[mp3|ogg]",A4:"A4.[mp3|ogg]","A#2":"As2.[mp3|ogg]","A#3":"As3.[mp3|ogg]","A#4":"As4.[mp3|ogg]",B2:"B2.[mp3|ogg]",B3:"B3.[mp3|ogg]",B4:"B4.[mp3|ogg]",C3:"C3.[mp3|ogg]",C4:"C4.[mp3|ogg]",C5:"C5.[mp3|ogg]","C#3":"Cs3.[mp3|ogg]","C#4":"Cs4.[mp3|ogg]","C#5":"Cs5.[mp3|ogg]",D2:"D2.[mp3|ogg]",D3:"D3.[mp3|ogg]",D4:"D4.[mp3|ogg]",D5:"D5.[mp3|ogg]","D#2":"Ds2.[mp3|ogg]","D#3":"Ds3.[mp3|ogg]","D#4":"Ds3.[mp3|ogg]",E2:"E2.[mp3|ogg]",E3:"E3.[mp3|ogg]",E4:"E4.[mp3|ogg]",F2:"F2.[mp3|ogg]",F3:"F3.[mp3|ogg]"},"guitar-electric":{"D#3":"Ds3.[mp3|ogg]","D#4":"Ds4.[mp3|ogg]","D#5":"Ds5.[mp3|ogg]",E2:"E2.[mp3|ogg]","F#2":"Fs2.[mp3|ogg]","F#3":"Fs3.[mp3|ogg]","F#4":"Fs4.[mp3|ogg]","F#5":"Fs5.[mp3|ogg]",A2:"A2.[mp3|ogg]",A3:"A3.[mp3|ogg]",A4:"A4.[mp3|ogg]",A5:"A5.[mp3|ogg]",C3:"C3.[mp3|ogg]",C4:"C4.[mp3|ogg]",C5:"C5.[mp3|ogg]",C6:"C6.[mp3|ogg]","C#2":"Cs2.[mp3|ogg]"},"guitar-nylon":{"F#2":"Fs2.[mp3|ogg]","F#3":"Fs3.[mp3|ogg]","F#4":"Fs4.[mp3|ogg]","F#5":"Fs5.[mp3|ogg]",G3:"G3.[mp3|ogg]",G5:"G3.[mp3|ogg]","G#2":"Gs2.[mp3|ogg]","G#4":"Gs4.[mp3|ogg]","G#5":"Gs5.[mp3|ogg]",A2:"A2.[mp3|ogg]",A3:"A3.[mp3|ogg]",A4:"A4.[mp3|ogg]",A5:"A5.[mp3|ogg]","A#5":"As5.[mp3|ogg]",B1:"B1.[mp3|ogg]",B2:"B2.[mp3|ogg]",B3:"B3.[mp3|ogg]",B4:"B4.[mp3|ogg]","C#3":"Cs3.[mp3|ogg]","C#4":"Cs4.[mp3|ogg]","C#5":"Cs5.[mp3|ogg]",D2:"D2.[mp3|ogg]",D3:"D3.[mp3|ogg]",D5:"D5.[mp3|ogg]","D#4":"Ds4.[mp3|ogg]",E2:"E2.[mp3|ogg]",E3:"E3.[mp3|ogg]",E4:"E4.[mp3|ogg]",E5:"E5.[mp3|ogg]"},harmonium:{C2:"C2.[mp3|ogg]",C3:"C3.[mp3|ogg]",C4:"C4.[mp3|ogg]",C5:"C5.[mp3|ogg]","C#2":"Cs2.[mp3|ogg]","C#3":"Cs3.[mp3|ogg]","C#4":"Cs4.[mp3|ogg]","C#5":"Cs5.[mp3|ogg]",D2:"D2.[mp3|ogg]",D3:"D3.[mp3|ogg]",D4:"D4.[mp3|ogg]",D5:"D5.[mp3|ogg]","D#2":"Ds2.[mp3|ogg]","D#3":"Ds3.[mp3|ogg]","D#4":"Ds4.[mp3|ogg]",E2:"E2.[mp3|ogg]",E3:"E3.[mp3|ogg]",E4:"E4.[mp3|ogg]",F2:"F2.[mp3|ogg]",F3:"F3.[mp3|ogg]",F4:"F4.[mp3|ogg]","F#2":"Fs2.[mp3|ogg]","F#3":"Fs3.[mp3|ogg]",G2:"G2.[mp3|ogg]",G3:"G3.[mp3|ogg]",G4:"G4.[mp3|ogg]","G#2":"Gs2.[mp3|ogg]","G#3":"Gs3.[mp3|ogg]","G#4":"Gs4.[mp3|ogg]",A2:"A2.[mp3|ogg]",A3:"A3.[mp3|ogg]",A4:"A4.[mp3|ogg]","A#2":"As2.[mp3|ogg]","A#3":"As3.[mp3|ogg]","A#4":"As4.[mp3|ogg]"},harp:{C5:"C5.[mp3|ogg]",D2:"D2.[mp3|ogg]",D4:"D4.[mp3|ogg]",D6:"D6.[mp3|ogg]",D7:"D7.[mp3|ogg]",E1:"E1.[mp3|ogg]",E3:"E3.[mp3|ogg]",E5:"E5.[mp3|ogg]",F2:"F2.[mp3|ogg]",F4:"F4.[mp3|ogg]",F6:"F6.[mp3|ogg]",F7:"F7.[mp3|ogg]",G1:"G1.[mp3|ogg]",G3:"G3.[mp3|ogg]",G5:"G5.[mp3|ogg]",A2:"A2.[mp3|ogg]",A4:"A4.[mp3|ogg]",A6:"A6.[mp3|ogg]",B1:"B1.[mp3|ogg]",B3:"B3.[mp3|ogg]",B5:"B5.[mp3|ogg]",B6:"B6.[mp3|ogg]",C3:"C3.[mp3|ogg]"},organ:{C3:"C3.[mp3|ogg]",C4:"C4.[mp3|ogg]",C5:"C5.[mp3|ogg]",C6:"C6.[mp3|ogg]","D#1":"Ds1.[mp3|ogg]","D#2":"Ds2.[mp3|ogg]","D#3":"Ds3.[mp3|ogg]","D#4":"Ds4.[mp3|ogg]","D#5":"Ds5.[mp3|ogg]","F#1":"Fs1.[mp3|ogg]","F#2":"Fs2.[mp3|ogg]","F#3":"Fs3.[mp3|ogg]","F#4":"Fs4.[mp3|ogg]","F#5":"Fs5.[mp3|ogg]",A1:"A1.[mp3|ogg]",A2:"A2.[mp3|ogg]",A3:"A3.[mp3|ogg]",A4:"A4.[mp3|ogg]",A5:"A5.[mp3|ogg]",C1:"C1.[mp3|ogg]",C2:"C2.[mp3|ogg]"},piano:{A7:"A7.[mp3|ogg]",A1:"A1.[mp3|ogg]",A2:"A2.[mp3|ogg]",A3:"A3.[mp3|ogg]",A4:"A4.[mp3|ogg]",A5:"A5.[mp3|ogg]",A6:"A6.[mp3|ogg]","A#7":"As7.[mp3|ogg]","A#1":"As1.[mp3|ogg]","A#2":"As2.[mp3|ogg]","A#3":"As3.[mp3|ogg]","A#4":"As4.[mp3|ogg]","A#5":"As5.[mp3|ogg]","A#6":"As6.[mp3|ogg]",B7:"B7.[mp3|ogg]",B1:"B1.[mp3|ogg]",B2:"B2.[mp3|ogg]",B3:"B3.[mp3|ogg]",B4:"B4.[mp3|ogg]",B5:"B5.[mp3|ogg]",B6:"B6.[mp3|ogg]",C7:"C7.[mp3|ogg]",C1:"C1.[mp3|ogg]",C2:"C2.[mp3|ogg]",C3:"C3.[mp3|ogg]",C4:"C4.[mp3|ogg]",C5:"C5.[mp3|ogg]",C6:"C6.[mp3|ogg]","C#7":"Cs7.[mp3|ogg]","C#1":"Cs1.[mp3|ogg]","C#2":"Cs2.[mp3|ogg]","C#3":"Cs3.[mp3|ogg]","C#4":"Cs4.[mp3|ogg]","C#5":"Cs5.[mp3|ogg]","C#6":"Cs6.[mp3|ogg]",D7:"D7.[mp3|ogg]",D1:"D1.[mp3|ogg]",D2:"D2.[mp3|ogg]",D3:"D3.[mp3|ogg]",D4:"D4.[mp3|ogg]",D5:"D5.[mp3|ogg]",D6:"D6.[mp3|ogg]","D#7":"Ds7.[mp3|ogg]","D#1":"Ds1.[mp3|ogg]","D#2":"Ds2.[mp3|ogg]","D#3":"Ds3.[mp3|ogg]","D#4":"Ds4.[mp3|ogg]","D#5":"Ds5.[mp3|ogg]","D#6":"Ds6.[mp3|ogg]",E7:"E7.[mp3|ogg]",E1:"E1.[mp3|ogg]",E2:"E2.[mp3|ogg]",E3:"E3.[mp3|ogg]",E4:"E4.[mp3|ogg]",E5:"E5.[mp3|ogg]",E6:"E6.[mp3|ogg]",F7:"F7.[mp3|ogg]",F1:"F1.[mp3|ogg]",F2:"F2.[mp3|ogg]",F3:"F3.[mp3|ogg]",F4:"F4.[mp3|ogg]",F5:"F5.[mp3|ogg]",F6:"F6.[mp3|ogg]","F#7":"Fs7.[mp3|ogg]","F#1":"Fs1.[mp3|ogg]","F#2":"Fs2.[mp3|ogg]","F#3":"Fs3.[mp3|ogg]","F#4":"Fs4.[mp3|ogg]","F#5":"Fs5.[mp3|ogg]","F#6":"Fs6.[mp3|ogg]",G7:"G7.[mp3|ogg]",G1:"G1.[mp3|ogg]",G2:"G2.[mp3|ogg]",G3:"G3.[mp3|ogg]",G4:"G4.[mp3|ogg]",G5:"G5.[mp3|ogg]",G6:"G6.[mp3|ogg]","G#7":"Gs7.[mp3|ogg]","G#1":"Gs1.[mp3|ogg]","G#2":"Gs2.[mp3|ogg]","G#3":"Gs3.[mp3|ogg]","G#4":"Gs4.[mp3|ogg]","G#5":"Gs5.[mp3|ogg]","G#6":"Gs6.[mp3|ogg]"},saxophone:{"D#5":"Ds5.[mp3|ogg]",E3:"E3.[mp3|ogg]",E4:"E4.[mp3|ogg]",E5:"E5.[mp3|ogg]",F3:"F3.[mp3|ogg]",F4:"F4.[mp3|ogg]",F5:"F5.[mp3|ogg]","F#3":"Fs3.[mp3|ogg]","F#4":"Fs4.[mp3|ogg]","F#5":"Fs5.[mp3|ogg]",G3:"G3.[mp3|ogg]",G4:"G4.[mp3|ogg]",G5:"G5.[mp3|ogg]","G#3":"Gs3.[mp3|ogg]","G#4":"Gs4.[mp3|ogg]","G#5":"Gs5.[mp3|ogg]",A4:"A4.[mp3|ogg]",A5:"A5.[mp3|ogg]","A#3":"As3.[mp3|ogg]","A#4":"As4.[mp3|ogg]",B3:"B3.[mp3|ogg]",B4:"B4.[mp3|ogg]",C4:"C4.[mp3|ogg]",C5:"C5.[mp3|ogg]","C#3":"Cs3.[mp3|ogg]","C#4":"Cs4.[mp3|ogg]","C#5":"Cs5.[mp3|ogg]",D3:"D3.[mp3|ogg]",D4:"D4.[mp3|ogg]",D5:"D5.[mp3|ogg]","D#3":"Ds3.[mp3|ogg]","D#4":"Ds4.[mp3|ogg]"},trombone:{"A#3":"As3.[mp3|ogg]",C3:"C3.[mp3|ogg]",C4:"C4.[mp3|ogg]","C#2":"Cs2.[mp3|ogg]","C#4":"Cs4.[mp3|ogg]",D3:"D3.[mp3|ogg]",D4:"D4.[mp3|ogg]","D#2":"Ds2.[mp3|ogg]","D#3":"Ds3.[mp3|ogg]","D#4":"Ds4.[mp3|ogg]",F2:"F2.[mp3|ogg]",F3:"F3.[mp3|ogg]",F4:"F4.[mp3|ogg]","G#2":"Gs2.[mp3|ogg]","G#3":"Gs3.[mp3|ogg]","A#1":"As1.[mp3|ogg]","A#2":"As2.[mp3|ogg]"},trumpet:{C6:"C6.[mp3|ogg]",D5:"D5.[mp3|ogg]","D#4":"Ds4.[mp3|ogg]",F3:"F3.[mp3|ogg]",F4:"F4.[mp3|ogg]",F5:"F5.[mp3|ogg]",G4:"G4.[mp3|ogg]",A3:"A3.[mp3|ogg]",A5:"A5.[mp3|ogg]","A#4":"As4.[mp3|ogg]",C4:"C4.[mp3|ogg]"},tuba:{"A#2":"As2.[mp3|ogg]","A#3":"As3.[mp3|ogg]",D3:"D3.[mp3|ogg]",D4:"D4.[mp3|ogg]","D#2":"Ds2.[mp3|ogg]",F1:"F1.[mp3|ogg]",F2:"F2.[mp3|ogg]",F3:"F3.[mp3|ogg]","A#1":"As1.[mp3|ogg]"},violin:{A3:"A3.[mp3|ogg]",A4:"A4.[mp3|ogg]",A5:"A5.[mp3|ogg]",A6:"A6.[mp3|ogg]",C4:"C4.[mp3|ogg]",C5:"C5.[mp3|ogg]",C6:"C6.[mp3|ogg]",C7:"C7.[mp3|ogg]",E4:"E4.[mp3|ogg]",E5:"E5.[mp3|ogg]",E6:"E6.[mp3|ogg]",G4:"G4.[mp3|ogg]",G5:"G5.[mp3|ogg]",G6:"G6.[mp3|ogg]"},xylophone:{C8:"C8.[mp3|ogg]",G4:"G4.[mp3|ogg]",G5:"G5.[mp3|ogg]",G6:"G6.[mp3|ogg]",G7:"G7.[mp3|ogg]",C5:"C5.[mp3|ogg]",C6:"C6.[mp3|ogg]",C7:"C7.[mp3|ogg]"}},C=new Tone.Chorus(4,2.5,.5).toDestination().start();synth1=(new Tone.PolySynth).connect(C);const A=new Tone.Distortion(.8).toDestination();synth2=(new Tone.FMSynth).connect(A),synth3=new Tone.PolySynth(Tone.Synth,{envelope:{attack:.02,decay:.1,sustain:.3,release:1}}).toDestination();const d=f("name"),D=f("track");let F;F="//cdn.jsdelivr.net/gh/zsyz2008/musicGames/song/"+d+".json";const G=document.getElementById("scoreGroup");let h;function f(g){for(var o=window.location.search.substring(1).split("&"),e=0;e<o.length;e++){var t=o[e].split("=");if(t[0]==g)return t[1]}return!1}fetch(F).then(g=>{if(200===g.status)return scoreContainer.innerHTML="加载音色中：0%",g.json();console.log("Looks like there was a problem. Status Code: "+g.status)}).then((function(g){h=g,document.getElementById("title").textContent=h.header.name;const o=h.header.timeSignatures[0].timeSignature[0],e=(h.header.timeSignatures[0].timeSignature[1],document.getElementById("scorePai"));for(let g=0;g<o;g++){const t=document.createElement("div");t.boxSizing="content-box",t.setAttribute("class","list"),g<o-1&&(t.style.borderRight="1px solid #db5a6b"),t.style.width=100/o+"%",t.textContent=g+1,e.appendChild(t)}return t=h,new Promise((g,o)=>{const e=+t.header.tempos[0].bpm,p=+t.header.timeSignatures[0].timeSignature[0],m=+t.header.timeSignatures[0].timeSignature[1]/1,n=t.header.keySignatures[0]?t.header.keySignatures[0].key:"C",s=4*p/m*(60/e),r={};let a=t.tracks;a=a.filter(g=>g.notes.length>0),a=a.filter(g=>"standard kit"!==g.instrument.name&&"jazz kit"!==g.instrument.name&&"brush kit"!==g.instrument.name);const i=a.find(g=>-1!==g.instrument.name.indexOf(" bass"));a=a.filter(g=>-1===g.instrument.name.indexOf(" bass")),i&&a.push(i),"solo"===D&&(a=a.filter((g,o)=>0===o)),"bz"===D&&(a=a.filter((g,o)=>0!==o));let c=(C=l.piano,new Promise((g,o)=>{let e;e="https://soundfont.s3.cn-north-1.jdcloud-oss.com/samples/"+C+"/";const t=new Tone.Sampler({urls:u[C],baseUrl:e,onload:o=>{g(t)}}).toDestination()}));var C;const A=[];for(let g of a){const o=g.instrument.name;l[o]||(console.log(o),c=Promise.resolve(synth1)),A.push(c)}(function(g,o){let e=0;return g.forEach(t=>{t.then(()=>{e++;const t=100*e/g.length;o(t)})}),Promise.all(g)})(A,(function(g){scoreContainer.innerHTML="加载音色中："+Math.ceil(g)+"%"})).then(o=>{a.forEach((g,e)=>{const t=o[e];g.notes.forEach(o=>{const p=o.time;let m,n=r[p];m=0===e?"solo":e===a.length-1&&-1!==g.instrument.name.indexOf(" bass")?"bass":"zt";const s={type:m,name:o.name,duration:o.duration,velocity:+o.velocity*{solo:1,bass:1,zt:.4}[m],synth:t,trackIndex:e};n?n.push(s):r[p]=[s]})});const e=[];let t=[],p=Object.keys(r).sort((function(g,o){return+g-+o}));for(let g of p)e.push(r[g]),t.push(g);const m=Math.ceil(t[t.length-1]/s),i={},c={},l={};for(let g=0;g<m;g++){const o=[];for(let e=0;e<t.length;e++)t[e]<(g+1)*s&&t[e]>=g*s&&(o.push({index:e,duration:t[e+1]-t[e]||1}),l[e]=o[0].index);const e=o[0]||"none";i[e.index]=o,c[e.index]=g}const u=a.length;g({notes:e,times:t,groupMap:i,groupValMap:c,trackLen:u,indexToGroupMap:l,keySignatures:n})})});var t})).then(g=>{!function(g){const{playBtn:o,scoreContainer:e,mid:n}=g,{notes:i,times:l,groupMap:u,groupValMap:C,indexToGroupMap:A,trackLen:d}=n;let D,F=0,h=-1,f=!1;document.getElementById("control").addEventListener("change",(function(g){f=!!g.target.checked})),e.addEventListener("touchstart",g=>{g.preventDefault()});const E=document.getElementById("staff"),y=document.getElementById("staffDiv");E.addEventListener("change",(function(g){g.target.checked?y.style.visibility="visible":y.style.visibility="hidden"}));const b=document.getElementById("reset");function B(){h++;const g=u[F];if(g){if(1===h)return void(h=0);!function(g){const{keySignatures:o}=n;t.innerHTML="";const e=new r(t,r.Backends.SVG),i=document.body.clientWidth;e.resize(i,320);const l=e.getContext(),u=new p(10,50,i-20).addKeySignature(o);u.addClef("treble").setContext(l).draw(),console.log(g,23);const C=[],A=[];for(let o of g){let g=[],e=[];for(let t of o){let o=t.name;var d=o.slice(-1),D=o.slice(0,-1)+"/"+d;+t.name.slice(o.length-1)>3?g.push(D):e.push(D)}g=[...new Set(g)],e=[...new Set(e)],C.push({ups:g}),A.push({downs:e})}const F=C.map(g=>{let o;return g.ups.length>0?(o=new m({keys:g.ups,duration:"q"}),console.log(g,23)):o=new m({keys:["B/4"],duration:"qr"}),o.autoStem(),o}),G=(new c).setMode(c.Mode.SOFT).addTickables(F);a.applyAccidentals([G],o),s.FormatAndDraw(l,u,F);const h=new p(10,150,i-20).addKeySignature(o);h.addClef("bass").setContext(l).draw();const f=A.map(g=>{let o;return o=g.downs.length>0?new m({keys:g.downs,duration:"q",stem_direction:-1,clef:"bass"}):new m({keys:["D/3"],duration:"qr",stem_direction:-1,clef:"bass"}),o.autoStem(),o}),E=(new c).setMode(c.Mode.SOFT).addTickables(f);a.applyAccidentals([E],o),s.FormatAndDraw(l,h,f)}(g.map(g=>i[g.index])),G.textContent="第"+(+C[F]+1)+"小节",D=[],e.innerHTML="",h=0;const o=g.reduce((g,o)=>g+o.duration,0);for(let t=0;t<g.length;t++){const p=document.createElement("button"),m=g[t];p.setAttribute("class","list button2 fire"),p.style.opacity=.3,p.style.width=100*m.duration/o+"%",0===t&&M(p),e.appendChild(p),D.push(p)}}}if(b&&b.addEventListener("click",()=>{F=A[F-1],h=0,B()}),B(),window.addEventListener("keydown",g=>{L()}),window.addEventListener("keyup",g=>{k()}),!navigator.requestMIDIAccess)return void console.log("当前浏览器不支持 MIDI 连接，请使用 Chrome 等支持 Web MIDI 的浏览器");let v=[];const w=g=>{const o=`${g.note.name}${g.note.accidental?g.note.accidental:""}${g.note.octave}`;v.push(Tone.Frequency(o).toMidi());const e=i[F].map(g=>Tone.Frequency(g.name).toMidi());let t=!0;for(let g of e)v.includes(g)||(t=!1);t&&L()},x=()=>{v=[]};function S(g){g&&g.preventDefault(),L()}function k(){var g;f&&T&&T.forEach(g=>{g.synth.triggerRelease(g.name)}),D&&D[h]&&(g=D[h])&&g.removeEventListener("touchstart",S)}function M(g){g&&(g.style.opacity=1,g.addEventListener("touchstart",S))}var T,I;function L(){f&&T&&T.forEach(g=>{g.synth.triggerRelease(g.name)});i[F+1];const g=i[F];T=g,g.forEach(g=>{!function(g){f?g.synth.triggerAttack(g.name,Tone.now(),g.velocity):g.synth.triggerAttackRelease(g.name,g.duration,Tone.now(),g.velocity)}(g)}),function(){B(),clearInterval(I);const g=D[h];if(!g)return;const o=l[F],e=l[F+1];let t;t=e?1e3*(e-o):3e3;let p,m=Date.now();I=setInterval(()=>{if(p<100)return clearInterval(I),p=0,g.style.opacity=0,M(D[h+1]),void(h===D.length-1&&(h=-1,B()));p=t-(Date.now()-m);const o=Math.ceil(100*p/t);g.style.opacity=o/100},10)}(),F===i.length-1?F=0:F++,k()}WebMidi.enable(()=>{if(0===WebMidi.inputs.length)return void console.log("没有找到可连接的 MIDI 设备，请检查 MIDI 设备是否正确连接");const g=WebMidi.inputs[0];g.addListener("noteon","all",w),g.addListener("noteoff","all",x)})}({playBtn:document.getElementById("playBtn"),scoreContainer:document.getElementById("scoreContainer"),mid:g})}),window.onload=function(){Tone.context.resume().then(()=>{Tone.Transport.start(),Tone.getContext().lookAhead=0,Tone.Transport.bpm.value=50})}}]);