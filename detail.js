!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([,function(e,t,n){window.onerror=function(e,t,n){return alert(e),!1};Vex.Flow;const o=document.getElementById("mystaff"),{Stave:r,StaveNote:a,Beam:s,Formatter:i,Renderer:c,Accidental:g,AccidentalManager:l,Voice:u}=Vex.Flow,m={flute:"flute",piano:"piano","lead 1 (square)":"lead_1_square","lead 5 (charang)":"lead_5_charang","electric bass (finger)":"electric_bass_finger","fretless bass":"fretless_bass","synthbrass 2":"synth_brass_2","fx 3 (crystal)":"fx_3_crystal","lead 2 (sawtooth)":"lead_2_sawtooth","overdriven guitar":"overdriven_guitar","string ensemble 1":"string_ensemble_1","orchestral harp":"orchestral_harp","acoustic grand piano":"acoustic_grand_piano","bright acoustic piano":"bright_acoustic_piano",vibraphone:"vibraphone",trumpet:"trumpet","acoustic guitar (steel)":"acoustic_guitar_steel","electric guitar (clean)":"electric_guitar_clean","soprano sax":"soprano_sax","tenor sax":"tenor_sax","pad 2 (warm)":"pad_2_warm","alto sax":"alto_sax","electric guitar (jazz)":"electric_guitar_jazz","acoustic bass":"acoustic_bass","synth bass 1":"synth_bass_1","drawbar organ":"drawbar_organ",piccolo:"piccolo",shamisen:"shamisen",xylophone:"xylophone",shakuhachi:"shakuhachi","church organ":"church_organ",cello:"cello",harmonica:"harmonium",trombone:"trombone","muted trumpet":"muted_trumpet",glockenspiel:"glockenspiel","bag pipe":"bagpipe","pan flute":"pan_flute",recorder:"recorder",clarinet:"clarinet",whistle:"whistle",accordion:"accordion","string ensemble 2":"string_ensemble_2","slap bass 1":"slap_bass_1","electric piano 2":"electric_piano_2",tuba:"tuba",oboe:"oboe","english horn":"english_horn","french horn":"french_horn",bassoon:"bassoon","synthstrings 1":"synth_strings_1","pizzicato strings":"pizzicato_strings",contrabass:"contrabass","acoustic guitar (nylon)":"acoustic_guitar_nylon","electric guitar (muted)":"electric_guitar_muted","distortion guitar":"distortion_guitar",timpani:"timpani",koto:"koto",ocarina:"ocarina","electric bass (pick)":"electric_bass_pick","music box":"music_box","electric piano 1":"electric_piano_1","brass section":"brass_section"},d={piano:{A7:"A7.[mp3|ogg]",A1:"A1.[mp3|ogg]",A2:"A2.[mp3|ogg]",A3:"A3.[mp3|ogg]",A4:"A4.[mp3|ogg]",A5:"A5.[mp3|ogg]",A6:"A6.[mp3|ogg]","A#7":"Bb7.[mp3|ogg]","A#1":"Bb1.[mp3|ogg]","A#2":"Bb2.[mp3|ogg]","A#3":"Bb3.[mp3|ogg]","A#4":"Bb4.[mp3|ogg]","A#5":"Bb5.[mp3|ogg]","A#6":"Bb6.[mp3|ogg]",B7:"B7.[mp3|ogg]",B1:"B1.[mp3|ogg]",B2:"B2.[mp3|ogg]",B3:"B3.[mp3|ogg]",B4:"B4.[mp3|ogg]",B5:"B5.[mp3|ogg]",B6:"B6.[mp3|ogg]",C7:"C7.[mp3|ogg]",C1:"C1.[mp3|ogg]",C2:"C2.[mp3|ogg]",C3:"C3.[mp3|ogg]",C4:"C4.[mp3|ogg]",C5:"C5.[mp3|ogg]",C6:"C6.[mp3|ogg]","C#7":"Db7.[mp3|ogg]","C#1":"Db1.[mp3|ogg]","C#2":"Db2.[mp3|ogg]","C#3":"Db3.[mp3|ogg]","C#4":"Db4.[mp3|ogg]","C#5":"Db5.[mp3|ogg]","C#6":"Db6.[mp3|ogg]",D7:"D7.[mp3|ogg]",D1:"D1.[mp3|ogg]",D2:"D2.[mp3|ogg]",D3:"D3.[mp3|ogg]",D4:"D4.[mp3|ogg]",D5:"D5.[mp3|ogg]",D6:"D6.[mp3|ogg]","D#7":"Eb7.[mp3|ogg]","D#1":"Eb1.[mp3|ogg]","D#2":"Eb2.[mp3|ogg]","D#3":"Eb3.[mp3|ogg]","D#4":"Eb4.[mp3|ogg]","D#5":"Eb5.[mp3|ogg]","D#6":"Eb6.[mp3|ogg]",E7:"E7.[mp3|ogg]",E1:"E1.[mp3|ogg]",E2:"E2.[mp3|ogg]",E3:"E3.[mp3|ogg]",E4:"E4.[mp3|ogg]",E5:"E5.[mp3|ogg]",E6:"E6.[mp3|ogg]",F7:"F7.[mp3|ogg]",F1:"F1.[mp3|ogg]",F2:"F2.[mp3|ogg]",F3:"F3.[mp3|ogg]",F4:"F4.[mp3|ogg]",F5:"F5.[mp3|ogg]",F6:"F6.[mp3|ogg]","F#7":"Gb7.[mp3|ogg]","F#1":"Gb1.[mp3|ogg]","F#2":"Gb2.[mp3|ogg]","F#3":"Gb3.[mp3|ogg]","F#4":"Gb4.[mp3|ogg]","F#5":"Gb5.[mp3|ogg]","F#6":"Gb6.[mp3|ogg]",G7:"G7.[mp3|ogg]",G1:"G1.[mp3|ogg]",G2:"G2.[mp3|ogg]",G3:"G3.[mp3|ogg]",G4:"G4.[mp3|ogg]",G5:"G5.[mp3|ogg]",G6:"G6.[mp3|ogg]","G#7":"Ab7.[mp3|ogg]","G#1":"Ab1.[mp3|ogg]","G#2":"Ab2.[mp3|ogg]","G#3":"Ab3.[mp3|ogg]","G#4":"Ab4.[mp3|ogg]","G#5":"Ab5.[mp3|ogg]","G#6":"Ab6.[mp3|ogg]"}},h=new Tone.Chorus(4,2.5,.5).toDestination().start();synth1=(new Tone.PolySynth).connect(h);const b=new Tone.Distortion(.8).toDestination();synth2=(new Tone.FMSynth).connect(b),synth3=new Tone.PolySynth(Tone.Synth,{envelope:{attack:.02,decay:.1,sustain:.3,release:1}}).toDestination();const f=D("name"),y=D("track");let _;_="//cdn.jsdelivr.net/gh/zsyz2008/musicGames/song/"+f+".json";const v=document.getElementById("scoreGroup");let w;function E(e){return new Promise((t,n)=>{let o;o="https://soundfont.s3-accelerate.cn-north-1.jdcloud-oss.com/FatBoy/"+e+"-mp3/";const r=new Tone.Sampler({urls:d.piano,baseUrl:o,onload:e=>{t(r)}}).toDestination()})}function D(e){for(var t=window.location.search.substring(1).split("&"),n=0;n<t.length;n++){var o=t[n].split("=");if(o[0]==e)return o[1]}return!1}fetch(_).then(e=>{if(200===e.status)return scoreContainer.innerHTML="加载音色中：0%",e.json();console.log("Looks like there was a problem. Status Code: "+e.status)}).then((function(e){w=e,document.getElementById("title").textContent=w.header.name;const t=w.header.timeSignatures[0].timeSignature[0],n=(w.header.timeSignatures[0].timeSignature[1],document.getElementById("scorePai"));for(let e=0;e<t;e++){const o=document.createElement("div");o.boxSizing="content-box",o.setAttribute("class","list"),e<t-1&&(o.style.borderRight="1px solid #db5a6b"),o.style.width=100/t+"%",o.textContent=e+1,n.appendChild(o)}return o=w,new Promise((e,t)=>{const n=+o.header.tempos[0].bpm,r=+o.header.timeSignatures[0].timeSignature[0],a=+o.header.timeSignatures[0].timeSignature[1]/1,s=o.header.keySignatures[0]?o.header.keySignatures[0].key:"C",i=4*r/a*(60/n),c={};let g=o.tracks;g=g.filter(e=>e.notes.length>0),g=g.filter(e=>"standard kit"!==e.instrument.name&&"jazz kit"!==e.instrument.name&&"brush kit"!==e.instrument.name);const l=g.find(e=>-1!==e.instrument.name.indexOf(" bass"));g=g.filter(e=>-1===e.instrument.name.indexOf(" bass")),l&&g.push(l),"solo"===y&&(g=g.filter((e,t)=>0===t)),"bz"===y&&(g=g.filter((e,t)=>0!==t));const u=[],d={};for(let e of g){const t=e.instrument.name;if(d[t])u.push(d[t]);else{if(m[t])try{p=E(m[t]),console.log(t,"音色")}catch(e){console.log(e,"load error"),p=Promise.resolve(synth3)}else console.log(t,"音源不存在"),p=Promise.resolve(synth1);d[t]=p,u.push(p)}}(function(e,t){let n=0;return e.forEach(o=>{o.then(()=>{n++;const o=100*n/e.length;t(o)})}),Promise.all(e)})(u,(function(e){scoreContainer.innerHTML="加载音色中："+Math.ceil(e)+"%"})).then(t=>{g.forEach((e,n)=>{const o=t[n];e.notes.forEach(t=>{const r=t.time;let a,s=c[r];a=0===n?"solo":n===g.length-1&&-1!==e.instrument.name.indexOf(" bass")?"bass":"zt";const i={type:a,name:t.name,duration:t.duration,velocity:+t.velocity*{solo:1,bass:1,zt:1}[a],synth:o,trackIndex:n};s?s.push(i):c[r]=[i]})});const n=[];let o=[],r=Object.keys(c).sort((function(e,t){return+e-+t}));for(let e of r)n.push(c[e]),o.push(e);const a=Math.ceil(o[o.length-1]/i),l={},p={},u={};for(let e=0;e<a;e++){const t=[];for(let n=0;n<o.length;n++)o[n]<(e+1)*i&&o[n]>=e*i&&(t.push({index:n,duration:o[n+1]-o[n]||1}),u[n]=t[0].index);const n=t[0]||"none";l[n.index]=t,p[n.index]=e}const m=g.length;e({notes:n,times:o,groupMap:l,groupValMap:p,trackLen:m,indexToGroupMap:u,keySignatures:s})})});var o})).then(e=>{!function(e){const{playBtn:t,scoreContainer:n,mid:s}=e,{notes:l,times:p,groupMap:m,groupValMap:d,indexToGroupMap:h,trackLen:b}=s;let f,y=0,_=-1,w=!1;document.getElementById("control").addEventListener("change",(function(e){w=!!e.target.checked})),n.addEventListener("touchstart",e=>{e.preventDefault()});const E=document.getElementById("staff"),D=document.getElementById("staffDiv");E.addEventListener("change",(function(e){e.target.checked?D.style.visibility="visible":D.style.visibility="hidden"}));const x=document.getElementById("reset");function C(){_++;const e=m[y];if(e){if(1===_)return void(_=0);!function(e){const{keySignatures:t}=s;o.innerHTML="";const n=new c(o,c.Backends.SVG),l=document.body.clientWidth;n.resize(l,280);const p=n.getContext(),m=new r(10,30,l-20).addKeySignature(t);m.addClef("treble").setContext(p).draw();const d=[],h=[];for(let t of e){let e=[],n=[];for(let o of t){let t=o.name;var b=t.slice(-1),f=t.slice(0,-1)+"/"+b;+o.name.slice(t.length-1)>3?e.push(f):n.push(f)}e=[...new Set(e)],n=[...new Set(n)],d.push({ups:e}),h.push({downs:n})}const y=d.map(e=>{let t;return t=e.ups.length>0?new a({keys:e.ups,duration:"q"}):new a({keys:["B/4"],duration:"qr"}),t.autoStem(),t}),_=(new u).setMode(u.Mode.SOFT).addTickables(y);g.applyAccidentals([_],t),i.FormatAndDraw(p,m,y);const v=new r(10,150,l-20).addKeySignature(t);v.addClef("bass").setContext(p).draw();const w=h.map(e=>{let t;return t=e.downs.length>0?new a({keys:e.downs,duration:"q",stem_direction:-1,clef:"bass"}):new a({keys:["D/3"],duration:"qr",stem_direction:-1,clef:"bass"}),t.autoStem(),t}),E=(new u).setMode(u.Mode.SOFT).addTickables(w);g.applyAccidentals([E],t),i.FormatAndDraw(p,v,w)}(e.map(e=>l[e.index])),v.textContent="第"+(+d[y]+1)+"小节",f=[],n.innerHTML="",_=0;const t=e.reduce((e,t)=>e+t.duration,0);for(let o=0;o<e.length;o++){const r=document.createElement("div"),a=e[o];r.setAttribute("class","list button2 fire"),r.style.opacity=.3,r.style.width=100*a.duration/t+"%",0===o&&G(r),n.appendChild(r),f.push(r)}}}if(x&&x.addEventListener("click",()=>{y=h[y-1],_=0,C()}),C(),t.style.visibility="visible",t.addEventListener("touchstart",e=>{T(),e.preventDefault()}),t.addEventListener("touchend",e=>{S()}),window.addEventListener("keydown",e=>{T()}),window.addEventListener("keyup",e=>{S()}),!navigator.requestMIDIAccess)return void console.log("当前浏览器不支持 MIDI 连接，请使用 Chrome 等支持 Web MIDI 的浏览器");const k=e=>{T()},A=()=>{};function B(e){e&&e.preventDefault(),T()}function S(){var e;w&&M&&M.forEach(e=>{e.synth.triggerRelease(e.name)}),f&&f[_]&&(e=f[_])&&e.removeEventListener("touchstart",B)}function G(e){e&&(e.style.opacity=1,e.addEventListener("touchstart",B))}var M,F;function T(){w&&M&&M.forEach(e=>{e.synth.triggerRelease(e.name)});l[y+1];const e=l[y];M=e,e.forEach(e=>{!function(e){w?e.synth.triggerAttack(e.name,Tone.now(),e.velocity):e.synth.triggerAttackRelease(e.name,e.duration,Tone.now(),e.velocity)}(e)}),function(){C(),clearInterval(F);const e=f[_];if(!e)return;const t=p[y],n=p[y+1];let o;o=n?1e3*(n-t):3e3;let r,a=Date.now();F=setInterval(()=>{if(r<100)return clearInterval(F),r=0,e.style.opacity=0,G(f[_+1]),void(_===f.length-1&&(_=-1,C()));r=o-(Date.now()-a);const t=Math.ceil(100*r/o);e.style.opacity=t/100},10)}(),y===l.length-1?y=0:y++,S()}WebMidi.enable(()=>{if(0===WebMidi.inputs.length)return void console.log("没有找到可连接的 MIDI 设备，请检查 MIDI 设备是否正确连接");const e=WebMidi.inputs[0];e.addListener("noteon","all",k),e.addListener("noteoff","all",A)})}({playBtn:document.getElementById("playBtn"),scoreContainer:document.getElementById("scoreContainer"),mid:e})}),window.onload=function(){Tone.context.resume().then(()=>{Tone.Transport.start(),Tone.getContext().lookAhead=0,Tone.Transport.bpm.value=50})}}]);