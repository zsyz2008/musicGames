!function(e){var t={};function n(o){if(t[o])return t[o].exports;var s=t[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(o,s,function(t){return e[t]}.bind(null,s));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([,function(e,t,n){class o{constructor(e){this.index=-1,this.specifiedLength=e,this.increasing=!0}incrementDecrement(){return this.increasing?this.index<this.specifiedLength?this.index++:(this.index--,this.increasing=!1):this.index>0?this.index--:(this.index++,this.increasing=!0),this.index}}window.onerror=function(e,t,n){return alert(e),!1};document.getElementById("mystaff");const s=document.getElementById("band");const i={},r={strings:"string",ensemble:"string",guitar:"guitar_liu","e-guitar":"distortion_guitar",piano:"piano",drums:"drum",bass:"bass",pipe:"flute",zt:"dance_woman",harpsichord:"guitar_liu",koto:"guitar_liu","orchestral harp":"guitar_liu",flute:"flute",clarinet:"flute",oboe:"flute",bassoon:"flute","voice oohs":"solo","choir aahs":"solo","standard kit":"drum","electronic kit":"drum",timpani:"drum","acoustic guitar (steel)":"guitar_sao1","acoustic guitar (nylon)":"guitar_liu","electric guitar (muted)":"guitar_sao2","electric guitar (jazz)":"guitar_liu",clavi:"guitar_liu","electric guitar (clean)":"guitar_liu","electric bass (finger)":"bass","acoustic bass":"bass","fretless bass":"bass","electric bass (pick)":"bass","slap bass 1":"bass","lead 8 bass":"bass","synth bass 1":"bass","synth bass 2":"bass","distortion guitar":"distortion_guitar2","overdriven guitar":"distortion_guitar","acoustic grand piano":"piano","bright acoustic piano":"piano","electric grand piano":"piano","honky-tonk piano":"piano","rock organ":"piano","string ensemble 1":"string","string ensemble 2":"string",violin:"string",cello:"string",contrabass:"string"},a={};function c(e){e=[...new Set(e)];const t={},n={};e.forEach(e=>{const c=r[e]||"dance_woman";var g;(g=c,new Promise((e,t)=>{let n;n="//cdn.jsdelivr.net/gh/zsyz2008/musicGames/movie/"+g+".json",fetch(n).then(t=>{200===t.status?e(t.json()):console.log("Looks like there was a problem. Status Code: "+t.status)})})).then((function(r){if(t[c]){const{typeObj:o,root:s}=t[c];i[e]=o,n[s].push(e)}else{const g=[];r.forEach(e=>{var t=new Image;t.style.width="40rem",t.src=e,g.push(t)});const u=document.createElement("div"),m=new o(g.length-1);let p=s;u.addEventListener("click",()=>{!1!==a[e]?(a[e]=!1,n[e].forEach(e=>{a[e]=!1}),u.style["-webkit-filter"]="grayscale(100%)"):(a[e]=!0,n[e].forEach(e=>{a[e]=!0}),u.style["-webkit-filter"]="none")}),p.appendChild(u);const d={dom:u,index:m,imgs:g};i[e]=d,t[c]={root:e,typeObj:d},n[e]=[],l([e])}}))})}function l(e){(e=[...new Set(e)]).forEach(e=>{const t=i[e];if(!t)return;t.dom.innerHTML="";const n=t.index.incrementDecrement();t.dom.appendChild(t.imgs[n])})}const g={flute:"flute","lead 1 (square)":"lead_1_square","lead 5 (charang)":"lead_5_charang","electric bass (finger)":"electric_bass_finger","fretless bass":"fretless_bass","slap bass 1":"slap_bass_1","synth bass 1":"synth_bass_1","synthbrass 2":"synth_brass_2","fx 3 (crystal)":"fx_3_crystal","lead 2 (sawtooth)":"lead_2_sawtooth","overdriven guitar":"overdriven_guitar","string ensemble 1":"string_ensemble_1","orchestral harp":"orchestral_harp","acoustic grand piano":"acoustic_grand_piano","bright acoustic piano":"bright_acoustic_piano",vibraphone:"vibraphone",trumpet:"trumpet","acoustic guitar (steel)":"acoustic_guitar_steel","electric guitar (clean)":"electric_guitar_clean","soprano sax":"soprano_sax","tenor sax":"tenor_sax","pad 2 (warm)":"pad_2_warm","alto sax":"alto_sax","electric guitar (jazz)":"electric_guitar_jazz","acoustic bass":"acoustic_bass","synth bass 1":"synth_bass_1","drawbar organ":"drawbar_organ",piccolo:"piccolo",shamisen:"shamisen",xylophone:"xylophone",shakuhachi:"shakuhachi","church organ":"church_organ",cello:"cello",harmonica:"harmonica",trombone:"trombone","muted trumpet":"muted_trumpet",glockenspiel:"glockenspiel","bag pipe":"bagpipe","pan flute":"pan_flute",recorder:"recorder",clarinet:"clarinet",whistle:"whistle",accordion:"accordion","string ensemble 2":"string_ensemble_2","slap bass 1":"slap_bass_1","electric piano 2":"electric_piano_2",tuba:"tuba",oboe:"oboe","english horn":"english_horn","french horn":"french_horn",bassoon:"bassoon","synthstrings 1":"synth_strings_1","pizzicato strings":"pizzicato_strings",contrabass:"contrabass","acoustic guitar (nylon)":"acoustic_guitar_nylon","electric guitar (muted)":"electric_guitar_muted","distortion guitar":"distortion_guitar",timpani:"timpani",koto:"koto",ocarina:"ocarina","electric bass (pick)":"electric_bass_pick","music box":"music_box","electric piano 1":"electric_piano_1","brass section":"brass_section","synth drum":"synth_drum","standard kit":"synth_drum","jazz kit":"synth_drum","brush kit":"synth_drum","electronic kit":"synth_drum",gunshot:"gunshot","synthbrass 1":"synth_brass_1","lead 8 bass":"lead_8_bass__lead","tubular bells":"tubular_bells",harpsichord:"harpsichord",violin:"violin",viola:"viola",marimba:"marimba","pad 8 (sweep)":"pad_8_sweep","pad 1 (new age)":"pad_1_new_age","fx 4 (atmosphere)":"fx_4_atmosphere","synthstrings 2":"synth_strings_2","power kit":"synth_drum",celesta:"celesta","lead 8 (bass + lead)":"lead_8_bass__lead","synth bass 2":"synth_bass_2",clavi:"clavinet","choir aahs":"choir_aahs","guitar fret noise":"guitar_fret_noise","synth voice":"synth_choir","rock organ":"rock_organ","percussive organ":"percussive_organ","fx 2 (soundtrack)":"fx_2_soundtrack","pad 3 (polysynth)":"\tpad_3_polysynth",sitar:"sitar","voice oohs":"voice_oohs","orchestra hit":"orchestra_hit","guitar harmonics":"guitar_harmonics","reverse cymbal":"reverse_cymbal","baritone sax":"baritone_sax","pad 4 (choir)":"pad_4_choir",kalimba:"kalimba","fx 5 (brightness)":"fx_5_brightness","telephone ring":"telephone_ring","electric grand piano":"electric_grand_piano","melodic tom":"melodic_tom","taiko drum":"taiko_drum","honky-tonk piano":"honkytonk_piano","tinkle bell":"tinkle_bell",applause:"applause",woodblock:"woodblock","lead 3 (calliope)":"lead_3_calliope","fx 1 (rain)":"fx_1_rain","lead 6 (voice)":"lead_6_voice","fx 7 (echoes)":"fx_7_echoes","bird tweet":"bird_tweet",helicopter:"helicopter"},u={all:{A7:"A7.[mp3|ogg]",A1:"A1.[mp3|ogg]",A2:"A2.[mp3|ogg]",A3:"A3.[mp3|ogg]",A4:"A4.[mp3|ogg]",A5:"A5.[mp3|ogg]",A6:"A6.[mp3|ogg]","A#7":"Bb7.[mp3|ogg]","A#1":"Bb1.[mp3|ogg]","A#2":"Bb2.[mp3|ogg]","A#3":"Bb3.[mp3|ogg]","A#4":"Bb4.[mp3|ogg]","A#5":"Bb5.[mp3|ogg]","A#6":"Bb6.[mp3|ogg]",B7:"B7.[mp3|ogg]",B1:"B1.[mp3|ogg]",B2:"B2.[mp3|ogg]",B3:"B3.[mp3|ogg]",B4:"B4.[mp3|ogg]",B5:"B5.[mp3|ogg]",B6:"B6.[mp3|ogg]",C7:"C7.[mp3|ogg]",C1:"C1.[mp3|ogg]",C2:"C2.[mp3|ogg]",C3:"C3.[mp3|ogg]",C4:"C4.[mp3|ogg]",C5:"C5.[mp3|ogg]",C6:"C6.[mp3|ogg]","C#7":"Db7.[mp3|ogg]","C#1":"Db1.[mp3|ogg]","C#2":"Db2.[mp3|ogg]","C#3":"Db3.[mp3|ogg]","C#4":"Db4.[mp3|ogg]","C#5":"Db5.[mp3|ogg]","C#6":"Db6.[mp3|ogg]",D7:"D7.[mp3|ogg]",D1:"D1.[mp3|ogg]",D2:"D2.[mp3|ogg]",D3:"D3.[mp3|ogg]",D4:"D4.[mp3|ogg]",D5:"D5.[mp3|ogg]",D6:"D6.[mp3|ogg]","D#7":"Eb7.[mp3|ogg]","D#1":"Eb1.[mp3|ogg]","D#2":"Eb2.[mp3|ogg]","D#3":"Eb3.[mp3|ogg]","D#4":"Eb4.[mp3|ogg]","D#5":"Eb5.[mp3|ogg]","D#6":"Eb6.[mp3|ogg]",E7:"E7.[mp3|ogg]",E1:"E1.[mp3|ogg]",E2:"E2.[mp3|ogg]",E3:"E3.[mp3|ogg]",E4:"E4.[mp3|ogg]",E5:"E5.[mp3|ogg]",E6:"E6.[mp3|ogg]",F7:"F7.[mp3|ogg]",F1:"F1.[mp3|ogg]",F2:"F2.[mp3|ogg]",F3:"F3.[mp3|ogg]",F4:"F4.[mp3|ogg]",F5:"F5.[mp3|ogg]",F6:"F6.[mp3|ogg]","F#7":"Gb7.[mp3|ogg]","F#1":"Gb1.[mp3|ogg]","F#2":"Gb2.[mp3|ogg]","F#3":"Gb3.[mp3|ogg]","F#4":"Gb4.[mp3|ogg]","F#5":"Gb5.[mp3|ogg]","F#6":"Gb6.[mp3|ogg]",G7:"G7.[mp3|ogg]",G1:"G1.[mp3|ogg]",G2:"G2.[mp3|ogg]",G3:"G3.[mp3|ogg]",G4:"G4.[mp3|ogg]",G5:"G5.[mp3|ogg]",G6:"G6.[mp3|ogg]","G#7":"Ab7.[mp3|ogg]","G#1":"Ab1.[mp3|ogg]","G#2":"Ab2.[mp3|ogg]","G#3":"Ab3.[mp3|ogg]","G#4":"Ab4.[mp3|ogg]","G#5":"Ab5.[mp3|ogg]","G#6":"Ab6.[mp3|ogg]"}},m={},d={B1:!0,C2:!0,"C#2":!0,D2:!0,"D#2":!0,E2:!0},h="true"===D("computer"),b=new Tone.Chorus(4,2.5,.5).toDestination().start();synth1=(new Tone.PolySynth).connect(b);const _=new Tone.Distortion(.8).toDestination();synth2=(new Tone.FMSynth).connect(_),synth3=new Tone.PolySynth(Tone.Synth,{envelope:{attack:.02,decay:.1,sustain:.3,release:1}}).toDestination();const y=D("name"),f=D("track"),v=document.getElementById("scoreInfo");let k;k="//cdn.jsdelivr.net/gh/zsyz2008/musicGames/song/"+y+".json";const E=document.getElementById("scoreGroup");let w;function x(e){return new Promise((t,n)=>{let o;o="https://soundfont.s3-accelerate.cn-north-1.jdcloud-oss.com/FatBoy/"+e+"-mp3/";const s=new Tone.Sampler({urls:m[e],baseUrl:o,onload:e=>{console.log(111),t(s)}}).toDestination()})}function D(e){for(var t=window.location.search.substring(1).split("&"),n=0;n<t.length;n++){var o=t[n].split("=");if(o[0]==e)return o[1]}return!1}fetch(k).then(e=>{if(200===e.status)return v.innerHTML="加载音色中：0%",e.json();console.log("Looks like there was a problem. Status Code: "+e.status)}).then((function(e){w=e,document.getElementById("title").textContent=w.header.name;const t=w.header.timeSignatures[0].timeSignature[0],n=(w.header.timeSignatures[0].timeSignature[1],document.getElementById("scorePai"));for(let e=0;e<t;e++){const o=document.createElement("div");o.boxSizing="content-box",o.setAttribute("class","list"),e<t-1&&(o.style.borderRight="1px solid #db5a6b"),o.style.width=100/t+"%",o.textContent=e+1,n.appendChild(o)}return o=w,new Promise((e,t)=>{const n=+o.header.tempos[0].bpm,s=+o.header.timeSignatures[0].timeSignature[0],i=+o.header.timeSignatures[0].timeSignature[1]/1,r=o.header.keySignatures[0]?o.header.keySignatures[0].key:"C",a=4*s/i*(60/n),l={};let b=o.tracks;b=b.filter(e=>e.notes.length>0),"solo"===f&&(b=b.filter((e,t)=>0===t)),"bz"===f&&(b=b.filter((e,t)=>0!==t));for(let e of b){const t=g[e.instrument.name],n=[...new Set(e.notes.map(e=>e.name))];m[t]?m[t]=[...new Set(m[t].concat(n))]:m[t]=n}Object.keys(m).forEach(e=>{const t={};m[e].forEach(e=>{const n=u.all[e];n&&(t[e]=n)}),m[e]=t});const _=[],y={};for(let e of b){const t=e.instrument.name;if(y[t])_.push(y[t]);else{if(g[t]&&!0!==h)try{p=x(g[t]),console.log(t,"音色")}catch(e){console.log(e,"load error"),p=Promise.resolve(synth3)}else console.log(t,"音源不存在"),p=Promise.resolve(synth1);y[t]=p,_.push(p)}}(function(e,t){let n=0;return e.forEach(o=>{o.then(()=>{n++;const o=100*n/e.length;t(o)})}),Promise.all(e)})(_,(function(e){v.innerHTML="加载音色中："+Math.ceil(e)+"%"})).then(t=>{v.innerHTML="";const n={},o={},s={};b.forEach((e,i)=>{const r=t[i];let a=e.notes;o[e.instrument.name]=!0,s[e.instrument.family]=!0;const c="drums"===e.instrument.family;c&&!0!==h&&(a=a.filter(e=>d[e.name])),a.forEach(t=>{const o=t.time;let s,a=l[o];0===i?(s="solo",n.solo=!0):i===b.length-1&&-1!==e.instrument.name.indexOf(" bass")?(s="bass",n.bass=!0):c?(s="drum",n.drum=!0):(s="zt",n.zt=!0);const g={type:s,instrument:e.instrument.name,instrument_family:e.instrument.family,name:t.name,duration:t.duration,velocity:+t.velocity*{solo:1,bass:1,zt:1,drum:.48}[s],synth:r,trackIndex:i};a?a.push(g):l[o]=[g]})}),c([].concat(Object.keys(o)));const i=[];let g=[],u=Object.keys(l).sort((function(e,t){return+e-+t}));for(let e of u)i.push(l[e]),g.push(e);const m=Math.ceil(g[g.length-1]/a),p={},_={},y={};for(let e=0;e<m;e++){const t=[];for(let n=0;n<g.length;n++)g[n]<(e+1)*a&&g[n]>=e*a&&(t.push({index:n,duration:g[n+1]-g[n]||1}),y[n]=t[0].index);const n=t[0]||"none";p[n.index]=t,_[n.index]=e}const f=b.length;e({notes:i,times:g,groupMap:p,groupValMap:_,trackLen:f,indexToGroupMap:y,keySignatures:r})})});var o})).then(e=>{!function(e){const{playBtn:t,scoreContainer:n,mid:o}=e,{notes:s,times:i,groupMap:r,groupValMap:c,indexToGroupMap:g,trackLen:u}=o;let m,p=0,d=-1,b=!1,_=!1;document.getElementById("control").addEventListener("change",(function(e){b=!!e.target.checked})),n.addEventListener("touchstart",e=>{e.preventDefault()});const f=document.getElementById("staff"),v=document.getElementById("staffDiv");f.addEventListener("change",(function(e){e.target.checked?v.style.visibility="visible":v.style.visibility="hidden"}));const k=document.getElementById("pre");k&&k.addEventListener("click",()=>{const e=g[p-1];void 0!==e&&(p=e,d=-1,A())});const w=document.getElementById("next");w&&w.addEventListener("click",()=>{if(void 0===g[p])return;const e=r[g[p]],t=g[e[e.length-1].index+1];void 0!==t&&(p=t,d=-1,A())});const x=document.getElementById("auto-play"),D=document.getElementById("gameContiner");let B;!0===h?B=new Tone.Player(`https://songs.s3.cn-north-1.jdcloud-oss.com/${y}.mp3`,()=>{console.log("MP3 文件加载完成！"),B.toDestination(),B.start(),x.style.visibility="visible"}):x.style.visibility="visible";x.addEventListener("click",()=>{x.style.visibility="hidden",D.style.display="none",_=!0,i.forEach(e=>{const t=setTimeout(()=>{F(),clearTimeout(t),C.pop(),0===C.length&&(D.style.display="block",_=!1)},1e3*e);C.push(t)}),A()});const C=[];function A(){d++;const e=r[p];if(e){if(1===d)return void(d=0);e.map(e=>s[e.index]);E.textContent="第"+(+c[p]+1)+"小节",m=[],n.innerHTML="",d=0;const t=e.reduce((e,t)=>e+t.duration,0);for(let o=0;o<e.length;o++){const s=document.createElement("div"),i=e[o];s.setAttribute("class","list button2 fire"),s.style.opacity=.3,s.style.width=100*i.duration/t+"%",0===o&&T(s),n.appendChild(s),m.push(s)}}}if(t.style.visibility="visible",t.addEventListener("touchstart",e=>{_||(F(),e.preventDefault())}),t.addEventListener("touchend",e=>{_||S()}),window.addEventListener("keydown",e=>{}),window.addEventListener("keyup",e=>{}),!navigator.requestMIDIAccess)return void console.log("当前浏览器不支持 MIDI 连接，请使用 Chrome 等支持 Web MIDI 的浏览器");function G(e){e&&e.preventDefault(),F()}function S(){var e;!0!==h&&b&&j&&j.forEach(e=>{e.synth.triggerRelease(e.name)}),m&&m[d]&&(e=m[d])&&e.removeEventListener("touchstart",G)}function T(e){e&&(e.style.opacity=1,e.addEventListener("touchstart",G))}var j;function F(){!0!==h&&b&&j&&j.forEach(e=>{e.synth.triggerRelease(e.name)});s[p+1];const e=s[p];j=e,e.forEach(e=>{!1!==a[e.instrument]?function(e){!0!==h&&(b?e.synth.triggerAttack(e.name,Tone.now(),e.velocity):e.synth.triggerAttackRelease(e.name,e.duration,Tone.now(),e.velocity))}(e):console.log(a[e.instrument],e.instrument)}),l(j.map(e=>e.type).concat(j.map(e=>e.instrument))),!_&&function(){A();let e=null;const t=m[d];if(!t)return;const n=i[p],o=i[p+1];let s;s=o?1e3*(o-n):3e3;let r=Date.now();!function n(){const o=s-(Date.now()-r);if(o<=0)return console.log(o,666),t.style.opacity=0,T(m[d+1]),void(d===m.length-1&&(d=-1,A()));e=requestAnimationFrame(n)}()}(),p===s.length-1?p=0:p++,S()}}({playBtn:document.getElementById("playBtn"),scoreContainer:document.getElementById("scoreContainer"),mid:e})}),window.onload=function(){Tone.context.resume().then(()=>{Tone.Transport.start(),Tone.getContext().lookAhead=0})}}]);