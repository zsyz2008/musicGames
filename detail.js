!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([,function(e,t){const n={flute:"flute",piano:"piano","lead 1 (square)":"flute","electric bass (finger)":"bass-electric","lead 2 (sawtooth)":"flute","overdriven guitar":"guitar-electric","string ensemble 1":"violin","orchestral harp":"piano","acoustic grand piano":"piano",vibraphone:"piano",trumpet:"trumpet","acoustic guitar (steel)":"guitar-acoustic","electric guitar (clean)":"guitar-electric","soprano sax":"saxophone","pad 2 (warm)":"violin","alto sax":"saxophone","electric guitar (jazz)":"guitar-electric","acoustic bass":"bass-electric","synth bass 1":"bass-electric","drawbar organ":"organ",piccolo:"flute",shamisen:"guitar-acoustic",xylophone:"xylophone","drawbar organ":"organ",shakuhachi:"clarinet","church organ":"organ",cello:"cello",harmonica:"harmonium",trombone:"trombone","muted trumpet":"trumpet",glockenspiel:"xylophone","bag pipe":"flute","pan flute":"flute",recorder:"organ",clarinet:"clarinet",whistle:"saxophone",accordion:"harmonium","string ensemble 2":"violin"},o=new Tone.Chorus(4,2.5,.5).toDestination().start();synth1=(new Tone.PolySynth).connect(o);const r=new Tone.Distortion(.8).toDestination();synth2=(new Tone.FMSynth).connect(r),synth3=new Tone.PolySynth(Tone.Synth,{envelope:{attack:.02,decay:.1,sustain:.3,release:1}}).toDestination();const a=document.getElementById("scoreGroup"),i=function(e){for(var t=window.location.search.substring(1).split("&"),n=0;n<t.length;n++){var o=t[n].split("=");if(o[0]==e)return o[1]}return!1}("name");let s;function l(e){return new Promise((t,n)=>{const o=new Tone.Sampler({urls:SampleLibrary[e],baseUrl:"https://soundfont.s3.cn-north-1.jdcloud-oss.com/samples/"+e+"/",onload:e=>{t(o)}}).toDestination()})}fetch("./song/"+i+".json").then(e=>{if(200===e.status)return e.json();console.log("Looks like there was a problem. Status Code: "+e.status)}).then((function(e){s=e,document.getElementById("title").textContent=s.header.name;const t=s.header.timeSignatures[0].timeSignature[0],o=document.getElementById("scoreTick");for(let e=0;e<t;e++){const n=document.createElement("div");n.setAttribute("class","list"),n.style.backgroundColor="#fff",e<t-1&&(n.style.borderRight="2px solid #db5a6b"),n.style.width=100/t+"%",n.textContent="第"+(e+1)+"拍",o.appendChild(n)}return r=s,new Promise((e,t)=>{const o=60/+r.header.tempos[0].bpm*+r.header.timeSignatures[0].timeSignature[0],a={};let i=r.tracks;i=i.filter(e=>e.notes.length>0),i=i.filter(e=>"standard kit"!==e.instrument.name);const s=[];for(let e of i){const t=e.instrument.name;let o;n[t]?o=l(n[t]):(console.log(t),o=Promise.resolve(synth1)),s.push(o)}Promise.all(s).then(e=>e).then(t=>{i.forEach((e,n)=>{const o=t[n];e.notes.forEach(e=>{const t=e.time;let r=a[t];r?r.push({solo:0===n,name:e.name,duration:e.duration,velocity:e.velocity,synth:o}):a[t]=[{solo:0===n,name:e.name,duration:e.duration,velocity:e.velocity,synth:o}]})});const n=[];let r=[],s=Object.keys(a).sort((function(e,t){return+e-+t}));for(let e of s)n.push(a[e]),r.push(e);const l=Math.ceil(r[r.length-1]/o),c={},u={};for(let e=0;e<l;e++){const t=[];for(let a=0;a<r.length;a++)r[a]<(e+1)*o&&r[a]>=e*o&&t.push({index:a,duration:r[a+1]-r[a]||1,solo:-1!==n[a].findIndex(e=>!0===e.solo)});const a=t[0]||"none";c[a.index]=t,u[a.index]=e}e({notes:n,times:r,groupMap:c,groupValMap:u})})});var r})).then(e=>{!function(e){const{playBtn:t,scoreContainer:n,mid:o,instrument:r}=e,{notes:i,times:s,groupMap:l,groupValMap:c}=o,u=r.solo.control,d=r.bz.control;let p,h,f=0,m=0;function y(){m++;const e=l[f];if(e){a.textContent="第"+(+c[f]+1)+"小节",h=[],n.innerHTML="",m=0;const t=e.reduce((e,t)=>e+t.duration,0);for(let o=0;o<e.length;o++){const r=document.createElement("div"),a=e[o];r.setAttribute("class","list"),r.style.width=100*a.duration/t+"%";const s=i[a.index];for(let e=0;e<s.length;e++){const t=s[e],n=document.createElement("div");n.setAttribute("class","avatar");const o=100/s.length;n.style.height=o+"%",n.style.top=o*e+"%",t.solo||(n.style.opacity=1/(e+2)),r.appendChild(n)}n.appendChild(r),h.push(r)}p=h.length}}function g(){b&&b.forEach(e=>{e.solo?u&&solo.triggerRelease(e.name):d&&bz.triggerRelease(e.name)})}y(),t.style.visibility="visible",t.addEventListener("touchstart",e=>{w(),e.preventDefault()}),t.addEventListener("touchend",e=>{g()}),t.addEventListener("mousedown",e=>{w(),e.preventDefault()}),t.addEventListener("mouseup",e=>{g()}),window.addEventListener("keydown",e=>{w()}),window.addEventListener("keyup",e=>{g()});let b,v;function w(){g();const e=i[f];b=e,e.forEach(e=>{e.solo?u?e.synth.triggerAttack(e.name,Tone.now(),.9*e.velocity):e.synth.triggerAttackRelease(e.name,e.duration,Tone.now(),.9*e.velocity):d?e.synth.triggerAttack(e.name,Tone.now(),.3*e.velocity):e.synth.triggerAttackRelease(e.name,e.duration,Tone.now(),.3*e.velocity)}),function(){if(h)for(let e of Array.prototype.slice.call(h[m].children))e.style.width="0%";y(),clearInterval(v);const e=h[m],t=s[f],n=s[f+1];let o;o=n?1e3*(n-t):3e3;let r,a=Date.now();v=setInterval(()=>{if(r<=0){i[f];clearInterval(v),r=0;for(let t of Array.prototype.slice.call(e.children))t.style.width="0%";return}r=o-(Date.now()-a);const t=Math.ceil(100*r/o);for(let n of Array.prototype.slice.call(e.children))n.style.width=t+"%"},30)}(),f===i.length-1?f=0:f++}}({playBtn:document.getElementById("playBtn"),scoreContainer:document.getElementById("scoreContainer"),mid:e,instrument:{solo:{control:!1},bz:{control:!1}}})}),window.onload=function(){Tone.context.resume().then(()=>{Tone.Transport.start(),Tone.getContext().lookAhead=0,Tone.Transport.bpm.value=50})}}]);