!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([,function(e,t){const n=["#e05915","#cdd422","#431c5d","#bccbde","#c2dde6","#431c5d","#3cc47c","#76323f","#cdd422","#431c5d","#bccbde","#c2dde6"],o={flute:"flute",piano:"piano","lead 1 (square)":"flute","electric bass (finger)":"bass-electric","lead 2 (sawtooth)":"flute","overdriven guitar":"guitar-electric","string ensemble 1":"violin","orchestral harp":"piano","acoustic grand piano":"piano",vibraphone:"piano",trumpet:"trumpet","acoustic guitar (steel)":"guitar-acoustic","electric guitar (clean)":"guitar-electric","soprano sax":"saxophone","pad 2 (warm)":"violin","alto sax":"saxophone","electric guitar (jazz)":"guitar-electric","acoustic bass":"bass-electric","synth bass 1":"bass-electric","drawbar organ":"organ",piccolo:"flute",shamisen:"guitar-acoustic",xylophone:"xylophone","drawbar organ":"organ",shakuhachi:"clarinet","church organ":"organ",cello:"cello",harmonica:"harmonium",trombone:"trombone","muted trumpet":"trumpet",glockenspiel:"xylophone","bag pipe":"flute","pan flute":"flute",recorder:"organ",clarinet:"clarinet",whistle:"saxophone",accordion:"harmonium","string ensemble 2":"violin"},r=new Tone.Chorus(4,2.5,.5).toDestination().start();synth1=(new Tone.PolySynth).connect(r);const a=new Tone.Distortion(.8).toDestination();synth2=(new Tone.FMSynth).connect(a),synth3=new Tone.PolySynth(Tone.Synth,{envelope:{attack:.02,decay:.1,sustain:.3,release:1}}).toDestination();const i=document.getElementById("scoreGroup"),l=function(e){for(var t=window.location.search.substring(1).split("&"),n=0;n<t.length;n++){var o=t[n].split("=");if(o[0]==e)return o[1]}return!1}("name");let s;function c(e){return new Promise((t,n)=>{const o=new Tone.Sampler({urls:SampleLibrary[e],baseUrl:"./samples/"+e+"/",onload:e=>{t(o)}}).toDestination()})}fetch("./song/"+l+".json").then(e=>{if(200===e.status)return e.json();console.log("Looks like there was a problem. Status Code: "+e.status)}).then((function(e){s=e,document.getElementById("title").textContent=s.header.name;const t=s.header.timeSignatures[0].timeSignature[0],n=document.getElementById("scoreTick"),r=document.getElementById("scorePai");for(let e=0;e<t;e++){const o=document.createElement("div");o.setAttribute("class","list"),o.style.zIndex=1,o.style.boxSizing="content-box",o.style.backgroundColor="rgba(0,0,0,0)",o.boxSizing="content-box",e<t-1&&(o.style.borderRight="1px solid #db5a6b"),o.style.width=100/t+"%",n.appendChild(o);const a=document.createElement("div");a.boxSizing="content-box",a.setAttribute("class","list"),a.style.backgroundColor="#fff",e<t-1&&(a.style.borderRight="1px solid #db5a6b"),a.style.width=100/t+"%",a.textContent="第"+(e+1)+"拍",r.appendChild(a)}return a=s,new Promise((e,t)=>{const n=60/+a.header.tempos[0].bpm*+a.header.timeSignatures[0].timeSignature[0],r={};let i=a.tracks;i=i.filter(e=>e.notes.length>0),i=i.filter(e=>"standard kit"!==e.instrument.name);const l=[];for(let e of i){const t=e.instrument.name;let n;o[t]?n=c(o[t]):(console.log(t),n=Promise.resolve(synth1)),l.push(n)}Promise.all(l).then(e=>e).then(t=>{i.forEach((e,n)=>{const o=t[n];e.notes.forEach(e=>{const t=e.time;let a=r[t];a?a.push({solo:0===n,name:e.name,duration:e.duration,velocity:e.velocity,synth:o,trackIndex:n}):r[t]=[{solo:0===n,name:e.name,duration:e.duration,velocity:e.velocity,synth:o,trackIndex:n}]})});const o=[];let a=[],l=Object.keys(r).sort((function(e,t){return+e-+t}));for(let e of l)o.push(r[e]),a.push(e);const s=Math.ceil(a[a.length-1]/n),c={},u={};for(let e=0;e<s;e++){const t=[];for(let r=0;r<a.length;r++)a[r]<(e+1)*n&&a[r]>=e*n&&t.push({index:r,duration:a[r+1]-a[r]||1,solo:-1!==o[r].findIndex(e=>!0===e.solo)});const r=t[0]||"none";c[r.index]=t,u[r.index]=e}const d=i.length;e({notes:o,times:a,groupMap:c,groupValMap:u,trackLen:d})})});var a})).then(e=>{!function(e){const{playBtn:t,scoreContainer:o,mid:r,instrument:a}=e,{notes:l,times:s,groupMap:c,groupValMap:u,trackLen:d}=r,h=a.solo.control,p=a.bz.control;let f,m=0,g=0;function y(){g++;const e=c[m];if(e){i.textContent="第"+(+u[m]+1)+"小节",f=[],o.innerHTML="",g=0;const t=e.reduce((e,t)=>e+t.duration,0);for(let r=0;r<e.length;r++){const a=document.createElement("div"),i=e[r];a.setAttribute("class","list"),a.style.width=100*i.duration/t+"%";const s=l[i.index];for(let e=0;e<d;e++){const t=document.createElement("div");t.setAttribute("class","avatar");const o=100/d;t.style.height=o+"%",t.style.top=o*e+"%";s[e];const r=s.filter(t=>t.trackIndex===e);0===r.length&&(t.style.backgroundColor="#eee");for(let o=0;o<r.length;o++){const a=r[o],i=document.createElement("div");i.setAttribute("class","fq"),i.style.height=100/r.length+"%",i.style.backgroundColor=n[e]||"#000",i.addEventListener("touchstart",e=>{v(a),e.preventDefault()}),t.appendChild(i)}a.appendChild(t)}o.appendChild(a),f.push(a)}}}function b(){w&&w.forEach(e=>{e.solo?h&&solo.triggerRelease(e.name):p&&bz.triggerRelease(e.name)})}function v(e){e.solo?h?e.synth.triggerAttack(e.name,Tone.now(),.9*e.velocity):e.synth.triggerAttackRelease(e.name,e.duration,Tone.now(),.9*e.velocity):p?e.synth.triggerAttack(e.name,Tone.now(),.3*e.velocity):e.synth.triggerAttackRelease(e.name,e.duration,Tone.now(),.3*e.velocity)}y(),t.style.visibility="visible",t.addEventListener("touchstart",e=>{k(),e.preventDefault()}),t.addEventListener("touchend",e=>{b()}),t.addEventListener("mousedown",e=>{k(),e.preventDefault()}),t.addEventListener("mouseup",e=>{b()}),window.addEventListener("keydown",e=>{k()}),window.addEventListener("keyup",e=>{b()});let w,x;function k(){b();const e=l[m];w=e,e.forEach(e=>{v(e)}),function(){if(f)for(let e of Array.prototype.slice.call(f[g].children))e.style.width="0%";y(),clearInterval(x);const e=f[g],t=s[m],n=s[m+1];let o;o=n?1e3*(n-t):3e3;let r,a=Date.now();x=setInterval(()=>{if(r<=0){l[m];clearInterval(x),r=0;for(let t of Array.prototype.slice.call(e.children))t.style.width="0%";return}r=o-(Date.now()-a);const t=Math.ceil(100*r/o);for(let n of Array.prototype.slice.call(e.children))n.style.width=t+"%"},30)}(),m===l.length-1?m=0:m++}}({playBtn:document.getElementById("playBtn"),scoreContainer:document.getElementById("scoreContainer"),mid:e,instrument:{solo:{control:!1},bz:{control:!1}}})}),window.onload=function(){Tone.context.resume().then(()=>{Tone.Transport.start(),Tone.getContext().lookAhead=0,Tone.Transport.bpm.value=50})}}]);