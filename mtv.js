!function(e){var t={};function n(o){if(t[o])return t[o].exports;var a=t[o]={i:o,l:!1,exports:{}};return e[o].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(o,a,function(t){return e[t]}.bind(null,a));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2)}({2:function(e,t,n){class o{constructor(e){this.index=-1,this.specifiedLength=e,this.increasing=!0}incrementDecrement(){return this.increasing?this.index<this.specifiedLength?this.index++:(this.index--,this.increasing=!1):this.index>0?this.index--:(this.index++,this.increasing=!0),this.index}}const a=document.getElementById("mystaff"),s=document.getElementById("band"),r=document.getElementById("solo"),i=document.getElementById("copy-right");r.style.transitionProperty="transform, opacity";const l={},c=decodeURIComponent(R("solo"))||"alto sax",d={};let u=0;function g(e){e=[...new Set(e)];const t={};e.forEach(e=>{if(e===c)return;const n="dance_woman";var a;(a=n,new Promise((e,t)=>{let n;n="//cdn.jsdelivr.net/gh/zsyz2008/musicGames/movie/"+a+".json?t="+(new Date).getTime(),fetch(n).then(t=>{200===t.status?e(t.json()):console.log("Looks like there was a problem. Status Code: "+t.status)})})).then((function(a){if(t[n]){const{typeObj:o,root:a}=t[n];l[e]=o}else{const r=[];a.forEach(e=>{var t=new Image;t.style.width="100%",t.src=e,r.push(t)});const i=document.createElement("div");i.classList.add("band-element");const c=new o(r.length-1);s.appendChild(i);const d={dom:i,index:c,imgs:r};l[e]=d,t[n]={root:e,typeObj:d}}}))})}let m=0;const{Stave:b,StaveNote:f,Beam:h,Formatter:y,Renderer:k,Accidental:_,AccidentalManager:x,Voice:v}=VexFlow,E={flute:"flute","lead 1 (square)":"lead_1_square","lead 5 (charang)":"lead_5_charang","electric bass (finger)":"electric_bass_finger","fretless bass":"fretless_bass","slap bass 1":"slap_bass_1","synth bass 1":"synth_bass_1","synthbrass 2":"synth_brass_2","fx 3 (crystal)":"fx_3_crystal","lead 2 (sawtooth)":"lead_2_sawtooth","overdriven guitar":"overdriven_guitar","string ensemble 1":"string_ensemble_1","orchestral harp":"orchestral_harp","acoustic grand piano":"acoustic_grand_piano","bright acoustic piano":"bright_acoustic_piano",vibraphone:"vibraphone",trumpet:"trumpet","acoustic guitar (steel)":"acoustic_guitar_steel","electric guitar (clean)":"electric_guitar_clean","soprano sax":"soprano_sax","tenor sax":"tenor_sax","pad 2 (warm)":"pad_2_warm","alto sax":"alto_sax","electric guitar (jazz)":"electric_guitar_jazz","acoustic bass":"acoustic_bass","synth bass 1":"synth_bass_1","drawbar organ":"drawbar_organ",piccolo:"piccolo",shamisen:"shamisen",xylophone:"xylophone",shakuhachi:"shakuhachi","church organ":"church_organ",cello:"cello",harmonica:"harmonica",trombone:"trombone","muted trumpet":"muted_trumpet",glockenspiel:"glockenspiel","bag pipe":"bagpipe","pan flute":"pan_flute",recorder:"recorder",clarinet:"clarinet",whistle:"whistle",accordion:"accordion","string ensemble 2":"string_ensemble_2","slap bass 1":"slap_bass_1","electric piano 2":"electric_piano_2",tuba:"tuba",oboe:"oboe","english horn":"english_horn","french horn":"french_horn",bassoon:"bassoon","synthstrings 1":"synth_strings_1","pizzicato strings":"pizzicato_strings",contrabass:"contrabass","acoustic guitar (nylon)":"acoustic_guitar_nylon","electric guitar (muted)":"electric_guitar_muted","distortion guitar":"distortion_guitar",timpani:"timpani",koto:"koto",ocarina:"ocarina","electric bass (pick)":"electric_bass_pick","music box":"music_box","electric piano 1":"electric_piano_1","brass section":"brass_section","synth drum":"synth_drum","standard kit":"synth_drum","jazz kit":"synth_drum","brush kit":"synth_drum","electronic kit":"synth_drum","tr-808 kit":"synth_drum",gunshot:"gunshot","synthbrass 1":"synth_brass_1","lead 8 bass":"lead_8_bass__lead","tubular bells":"tubular_bells",harpsichord:"harpsichord",violin:"violin",viola:"viola",marimba:"marimba","pad 8 (sweep)":"pad_8_sweep","pad 1 (new age)":"pad_1_new_age","fx 4 (atmosphere)":"fx_4_atmosphere","synthstrings 2":"synth_strings_2","power kit":"synth_drum",celesta:"celesta","lead 8 (bass + lead)":"lead_8_bass__lead","synth bass 2":"synth_bass_2",clavi:"clavinet","choir aahs":"choir_aahs","guitar fret noise":"guitar_fret_noise","synth voice":"synth_choir","rock organ":"rock_organ","percussive organ":"percussive_organ","fx 2 (soundtrack)":"fx_2_soundtrack","pad 3 (polysynth)":"\tpad_3_polysynth",sitar:"sitar","voice oohs":"voice_oohs","orchestra hit":"orchestra_hit","guitar harmonics":"guitar_harmonics","reverse cymbal":"reverse_cymbal","baritone sax":"baritone_sax","pad 4 (choir)":"pad_4_choir",kalimba:"kalimba","fx 5 (brightness)":"fx_5_brightness","telephone ring":"telephone_ring","electric grand piano":"electric_grand_piano","melodic tom":"melodic_tom","taiko drum":"taiko_drum","honky-tonk piano":"honkytonk_piano","tinkle bell":"tinkle_bell",applause:"applause",woodblock:"woodblock","lead 3 (calliope)":"lead_3_calliope","fx 1 (rain)":"fx_1_rain","lead 6 (voice)":"lead_6_voice","fx 7 (echoes)":"fx_7_echoes","bird tweet":"bird_tweet",helicopter:"helicopter",seashore:"seashore","pad 7 (halo)":"pad_7_halo","pad 6 (metallic)":"pad_6_metallic"},w={all:{A7:"A7.[mp3|ogg]",A1:"A1.[mp3|ogg]",A2:"A2.[mp3|ogg]",A3:"A3.[mp3|ogg]",A4:"A4.[mp3|ogg]",A5:"A5.[mp3|ogg]",A6:"A6.[mp3|ogg]","A#7":"Bb7.[mp3|ogg]","A#1":"Bb1.[mp3|ogg]","A#2":"Bb2.[mp3|ogg]","A#3":"Bb3.[mp3|ogg]","A#4":"Bb4.[mp3|ogg]","A#5":"Bb5.[mp3|ogg]","A#6":"Bb6.[mp3|ogg]",B7:"B7.[mp3|ogg]",B1:"B1.[mp3|ogg]",B2:"B2.[mp3|ogg]",B3:"B3.[mp3|ogg]",B4:"B4.[mp3|ogg]",B5:"B5.[mp3|ogg]",B6:"B6.[mp3|ogg]",C7:"C7.[mp3|ogg]",C1:"C1.[mp3|ogg]",C2:"C2.[mp3|ogg]",C3:"C3.[mp3|ogg]",C4:"C4.[mp3|ogg]",C5:"C5.[mp3|ogg]",C6:"C6.[mp3|ogg]","C#7":"Db7.[mp3|ogg]","C#1":"Db1.[mp3|ogg]","C#2":"Db2.[mp3|ogg]","C#3":"Db3.[mp3|ogg]","C#4":"Db4.[mp3|ogg]","C#5":"Db5.[mp3|ogg]","C#6":"Db6.[mp3|ogg]",D7:"D7.[mp3|ogg]",D1:"D1.[mp3|ogg]",D2:"D2.[mp3|ogg]",D3:"D3.[mp3|ogg]",D4:"D4.[mp3|ogg]",D5:"D5.[mp3|ogg]",D6:"D6.[mp3|ogg]","D#7":"Eb7.[mp3|ogg]","D#1":"Eb1.[mp3|ogg]","D#2":"Eb2.[mp3|ogg]","D#3":"Eb3.[mp3|ogg]","D#4":"Eb4.[mp3|ogg]","D#5":"Eb5.[mp3|ogg]","D#6":"Eb6.[mp3|ogg]",E7:"E7.[mp3|ogg]",E1:"E1.[mp3|ogg]",E2:"E2.[mp3|ogg]",E3:"E3.[mp3|ogg]",E4:"E4.[mp3|ogg]",E5:"E5.[mp3|ogg]",E6:"E6.[mp3|ogg]",F7:"F7.[mp3|ogg]",F1:"F1.[mp3|ogg]",F2:"F2.[mp3|ogg]",F3:"F3.[mp3|ogg]",F4:"F4.[mp3|ogg]",F5:"F5.[mp3|ogg]",F6:"F6.[mp3|ogg]","F#7":"Gb7.[mp3|ogg]","F#1":"Gb1.[mp3|ogg]","F#2":"Gb2.[mp3|ogg]","F#3":"Gb3.[mp3|ogg]","F#4":"Gb4.[mp3|ogg]","F#5":"Gb5.[mp3|ogg]","F#6":"Gb6.[mp3|ogg]",G7:"G7.[mp3|ogg]",G1:"G1.[mp3|ogg]",G2:"G2.[mp3|ogg]",G3:"G3.[mp3|ogg]",G4:"G4.[mp3|ogg]",G5:"G5.[mp3|ogg]",G6:"G6.[mp3|ogg]","G#7":"Ab7.[mp3|ogg]","G#1":"Ab1.[mp3|ogg]","G#2":"Ab2.[mp3|ogg]","G#3":"Ab3.[mp3|ogg]","G#4":"Ab4.[mp3|ogg]","G#5":"Ab5.[mp3|ogg]","G#6":"Ab6.[mp3|ogg]"}},D={};let C={};const S="true"===R("computer"),B="true"===R("video");var A=[];const M=new Tone.Chorus(4,2.5,.5).toDestination().start(),T=new Tone.Reverb({decay:1.5,wet:.2,preDelay:.1}).toDestination(),G=new Tone.Compressor({threshold:-20,ratio:2,attack:.02,release:.2}).toDestination(),F=new Tone.EQ3({low:1,mid:0,high:-1}).toDestination(),I=new Tone.Filter({type:"peaking",frequency:80,Q:.8,gain:1.5}).toDestination();M.chain(G,F,I,T),synth1=new Tone.PolySynth({volume:4,oscillator:{type:"sine"},envelope:{attack:.005,decay:.1,sustain:.3,release:.1}}).connect(F);const L=new Tone.Distortion(.4).connect(F);synth2=new Tone.FMSynth({volume:4,harmonicity:2.5,modulationIndex:8,oscillator:{type:"triangle"},envelope:{attack:.005,decay:.2,sustain:.3,release:.1},modulation:{type:"square"},modulationEnvelope:{attack:.005,decay:.2,sustain:.2,release:.1}}).connect(L),synth3=new Tone.PolySynth(Tone.Synth,{volume:4,oscillator:{type:"sine"},envelope:{attack:.005,decay:.1,sustain:.3,release:.1}}).connect(F),Tone.Destination.volume.value=-3;const j=R("name"),z=R("track"),P=document.getElementById("scoreInfo");document.getElementById("linkContainer");let $;$="https://soundfont.s3-accelerate.cn-north-1.jdcloud-oss.com/json/"+j+".json?t="+(new Date).getTime();const O=document.getElementById("scoreGroup");let H;function q(e){return new Promise((t,n)=>{let o;o="https://soundfont.s3-accelerate.cn-north-1.jdcloud-oss.com/FatBoy/"+e+"-mp3/";const a=new Tone.Gain(1.05).connect(I),s=new Tone.Sampler({urls:D[e],baseUrl:o,onload:e=>{console.log("loaded"),s.connect(a),t(s)}}).toDestination()})}function R(e){for(var t=window.location.search.substring(1).split("&"),n=0;n<t.length;n++){var o=t[n].split("=");if(o[0]==e)return o[1]}return!1}function N(e){return e.replace(/\d/g,"")}fetch($).then(e=>{if(200===e.status)return P.innerHTML="加载音色中：0%",e.json();console.log("Looks like there was a problem. Status Code: "+e.status)}).then((function(e){H=e,H=function(e,t=.05){if(!e.tracks)return e;const n=[];e.tracks.forEach((e,t)=>{e.notes&&e.notes.forEach(e=>{n.push({...e,trackIndex:t})})}),n.sort((e,t)=>e.time-t.time);let o=0;for(;o<n.length;){const e=n[o].time;let a=o+1;for(;a<n.length&&Math.abs(n[a].time-e)<=t;)n[a].time=e,a++;o=a}return e.tracks.forEach(e=>{e.notes=[]}),n.forEach(t=>{e.tracks[t.trackIndex].notes.push(t)}),e.tracks.forEach(e=>{e.notes.sort((e,t)=>e.time-t.time)}),e}(H),H=function(e,t="C2",n="E6"){const o=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function a(e){const t=e.match(/^([A-G]#?)(-?\d)$/);if(!t)throw new Error("Invalid note: "+e);const[n,a,s]=t,r=o.indexOf(a);return 12*(parseInt(s)+1)+r}const s=a(t),r=a(n),i=e=>{if(e>=s&&e<=r)return e;const t=e%12,n=[];for(let e=s;e<=r;e++)e%12===t&&n.push(e);if(0===n.length)return s+t%12;let o=n[0],a=Math.abs(e-o);for(let t=1;t<n.length;t++){const s=Math.abs(e-n[t]);s<a&&(a=s,o=n[t])}return o},l=new Set;for(const t of e.tracks)if("drums"!==t.instrument.family){for(const e of t.notes){e.midi=i(e.midi);const t=Math.floor(e.midi/12)-1;e.name=o[e.midi%12]+t}t.notes=t.notes.filter(e=>{const t=`${e.time}_${e.midi}`;return!l.has(t)&&(l.add(t),!0)})}return e}(H),document.getElementById("title").textContent=H.header.name;const t=H.header.timeSignatures[0].timeSignature[0],n=(H.header.timeSignatures[0].timeSignature[1],document.getElementById("scorePai"));document.getElementById("keySignatures").innerHTML=H.header.keySignatures[0].key+"调";const o=t;for(let e=0;e<o;e++){const t=document.createElement("div");t.boxSizing="content-box",t.setAttribute("class","list"),t.style.backgroundImage="linear-gradient(to bottom, rgba(220, 40, 30, .7), rgba(180, 20, 20, .7))",t.style.width=100/o+"%",t.textContent=e+1,n.appendChild(t)}return a=H,new Promise((e,t)=>{const n=+a.header.tempos[0].bpm,o=+a.header.timeSignatures[0].timeSignature[0],s=+a.header.timeSignatures[0].timeSignature[1]/1,r=a.header.keySignatures[0]?a.header.keySignatures[0].key:"C",i=4*o/s*(60/n),l={};let c=a.tracks;if(c=c.filter(e=>e.notes.length>0),c=c.filter(e=>"drums"!==e.instrument.family),console.log(c,"音轨"),z){const e=z.split(",");console.log(e,333),c=c.filter((t,n)=>-1!==e.indexOf(encodeURIComponent(t.instrument.name)))}console.log(c,"音轨新"),C=c.map(e=>e.instrument.name),C=[...new Set(C)],console.log(C,222222);for(let e of c){const t=E[e.instrument.name],n=[...new Set(e.notes.map(e=>e.name))];D[t]?D[t]=[...new Set(D[t].concat(n))]:D[t]=n}Object.keys(D).forEach(e=>{const t={};D[e].forEach(e=>{const n=w.all[e];n&&(t[e]=n)}),D[e]=t});const d=[],u={};for(let e of c){const t=e.instrument.name;if(u[t])d.push(u[t]);else{if(E[t]&&!0!==S)try{p=q(E[t])}catch(e){console.log(e,"load error"),p=Promise.resolve(synth3)}else console.log(t,"音源不存在"),p=Promise.resolve(synth1);u[t]=p,d.push(p)}}(function(e,t){let n=0;return e.forEach(o=>{o.then(()=>{n++;const o=100*n/e.length;t(o)})}),Promise.all(e)})(d,(function(e){P.innerHTML="加载音色中："+Math.ceil(e)+"%"})).then(t=>{P.innerHTML="";const n={},o={},a={};c.forEach((e,s)=>{const r=t[s];let i=e.notes;o[e.instrument.name]=!0,a[e.instrument.family]=!0;const c="drums"===e.instrument.family||"timpani"===e.instrument.name;i.forEach(t=>{const o=t.time;let a,i=l[o];"bass"===e.instrument.family?(a="bass",n.bass=!0):c?(a="drum",n.drum=!0):(a="zt",n.zt=!0);const d={type:a,instrument:e.instrument.name,instrument_family:e.instrument.family,name:t.name,duration:t.duration,velocity:t.velocity,synth:r,trackIndex:s};i?i.push(d):l[o]=[d]})}),g([].concat(Object.keys(o)));let s=[],d=[],u=Object.keys(l).sort((function(e,t){return+e-+t}));for(let e of u)s.push(l[e]),d.push(e);const m=Math.ceil(d[d.length-1]/i),b={},f={},p={};for(let e=0;e<m;e++){const t=e*i;if(!d.includes(t)){const e=d.filter(e=>e>t).sort((e,t)=>e-t)[0];if((void 0!==e?e-t:i)>=0){const e={type:"rest",instrument:"rest",instrument_family:"rest",name:"rest",duration:1,velocity:0,synth:null,trackIndex:-1};l[t]||(l[t]=[e],d.push(t))}}}d.sort((e,t)=>e-t),s=[];for(let e of d)s.push(l[e]);for(let e=0;e<m;e++){const t=[];for(let n=0;n<d.length;n++)d[n]<(e+1)*i&&d[n]>=e*i&&(t.push({index:n,duration:d[n+1]-d[n]||1,highlight:s[n].some(e=>"bass"===e.type||"drum"===e.type),rest:s[n].some(e=>"rest"===e.type)}),p[n]=t[0].index);const n=t[0]||"none";b[n.index]=t,f[n.index]=e}const h=c.length;e({notes:s,times:d,groupMap:b,groupValMap:f,trackLen:h,indexToGroupMap:p,keySignatures:r})})});var a})).then(e=>{!function(e){const{playBtn:t,scoreContainer:n,mid:o}=e,{notes:g,times:p,groupMap:h,groupValMap:x,indexToGroupMap:E,trackLen:w}=o;let D,M=0,T=-1,G=!0;Q(),n.addEventListener("touchstart",e=>{e.preventDefault()});const F=document.getElementById("pre");F&&F.addEventListener("click",e=>{e.preventDefault();const t=E[M-1];void 0!==t&&(M=t,T=-1,Q())});const I=document.getElementById("next");I&&I.addEventListener("click",e=>{if(e.preventDefault(),void 0===E[M])return;const t=h[E[M]],n=E[t[t.length-1].index+1];void 0!==n&&(M=n,T=-1,Q())});const L=document.getElementById("auto-play"),z=document.getElementById("myVideo");let P,$;z.removeAttribute("controls"),!0===S?!0===B?($="./mp3/"+j+".mov",H=$,console.log("show"),z.src=H,z.addEventListener("loadeddata",()=>{alert("mov 文件加载完成！")}),z.load()):(z.style.display="none",$="https://soundfont.s3-accelerate.cn-north-1.jdcloud-oss.com/mp3/"+j+".mp3",P=new Tone.Player($,()=>{alert("MP3 文件加载完成！"),L.style.visibility="visible"})):(z.style.display="none",L.style.visibility="visible");var H;let q=!1;function R(){!1===q?(!0===S&&(!0===B?(s.style.display="none",z.play()):(P.toDestination(),P.start())),function(){console.log("playyyyyyyyyy"),L.style.opacity=0,G=!0;let e=0;p.forEach((t,n)=>{const o=setTimeout(()=>{X();const t=g[n].filter(e=>e.instrument===c);if(t.length>0){let e=t[0].duration;e=Math.max(e,.4),r.style.transitionDuration=e+"s",document.body.style.transitionDuration=e+"s",r.classList.contains("active")?r.classList.remove("active"):r.classList.add("active")}e=n;const a=E[e],s=h[a];if(s){s.map(e=>g[e.index]),s.findIndex(t=>t.index===e)}te(),clearTimeout(o),U.shift(),0===U.length&&W()},1e3*t);U.push(o)})}(),Q(),q=!0):W()}L.addEventListener("click",R);const U=[];function W(){!0!==S&&(n.style.display="flex",r.style.display="none",F.style.display="inline-block",I.style.display="inline-block",a.innerHTML="",t.style.display="flex",i.style.display="none",C.forEach(e=>{}),G=!1,U.forEach(e=>{clearTimeout(e)}),U.splice(0,U.length),L.removeEventListener("click",R),L.style.visibility="hidden",M=0,T=-1,Q())}function Q(){T++;const e=h[M];if(e){if(1===T)return void(T=0);const t=e.map(e=>g[e.index]);O.textContent="第"+(+x[M]+1)+"小节",D=[],n.innerHTML="",T=0;const o=e.reduce((e,t)=>e+t.duration,0);for(let a=0;a<e.length;a++){const s=document.createElement("div"),r=e[a];s.setAttribute("class","list button2 fire");const i=document.createElement("div");i.className="staff-label",s.appendChild(i),r.rest?s.style.backgroundColor="rgba(120, 130, 150, 0.3)":r.highlight?s.style.backgroundColor="rgba(255, 80, 100, 0.85)":s.style.backgroundColor="rgba(255, 170, 50, 0.8)",s.style.borderRadius="8px";let l=100*r.duration/o;Z([t[a]],a,0===a,l/100),s.style.opacity=.6,s.style.width=l+"%",n.appendChild(s),D.push(s)}}}if(t.addEventListener("touchstart",e=>{G||(te(),e.preventDefault())}),t.addEventListener("touchend",e=>{G||X()}),t.addEventListener("mousedown",e=>{te(),e.preventDefault()}),t.addEventListener("mouseup",e=>{X()}),window.addEventListener("keydown",e=>{}),window.addEventListener("keyup",e=>{}),!navigator.requestMIDIAccess)return void console.log("当前浏览器不支持 MIDI 连接，请使用 Chrome 等支持 Web MIDI 的浏览器");function J(e){e&&e.preventDefault(),te()}function X(e){!0!==S&&!G&&ee&&ee.forEach(e=>{"rest"!==e.type&&e.synth.triggerRelease(e.name)});const t=D[T];var n;D&&t&&(A[T]&&(A[T].style.opacity=0),t.style.opacity=0,(n=t)&&(n.removeEventListener("touchstart",J),n.removeEventListener("touchend",X))),Q()}function Y(e,t){const n={"C#":"Db","D#":"Eb","E#":"F","F#":"Gb","G#":"Ab","A#":"Bb","B#":"C",Db:"C#",Eb:"D#",Fb:"E",Gb:"F#",Ab:"G#",Bb:"A#",Cb:"B"},o=["F","Bb","Eb","Ab","Db","Gb","Cb"].includes(t),a=["G","D","A","E","B","F#","C#"].includes(t),s=e.slice(0,-1),r=e.slice(-1);return o&&n[s]&&n[s].endsWith("b")||o&&s.includes("#")||a&&s.includes("b")?n[s]+r:e}function Z(e,t=-1,n,s=1,r={}){const{isDarkMode:i=!0,staffColor:l=(i?"#ffffff":"#000000"),noteColor:c=(i?"#ffffff":"#000000"),backgroundColor:d=(i?"#000":"#ffffff")}=r;n&&(u%1==0&&(u=0,a.innerHTML=""),u++,A=[]);const{keySignatures:g}=o,m=document.createElement("div");m.className="staff-group",m.style.width=100*s+"%",m.style.backgroundColor=d,a.appendChild(m),A.push(m),(e[0].length<3||s<.1)&&(m.style.visibility="hidden"),m.style.opacity=.5;const p=new k(m,k.Backends.SVG),h=(document.body.clientWidth-5)*s/.9;p.resize(h,180);const x=p.getContext().scale(.9,.9);x.setStrokeStyle(l),x.setFillStyle(l);const E=new b(-16,0,h+15);E.setEndBarType(0),E.setContext(x).draw();const w=[],D=[];function C(e){try{return Flow.ticksToDuration(e)}catch(e){return"w"}}for(let t=0;t<e.length;t++){const n=e[t];let o=[],a=[],s=n.length>0&&n[0].duration||"q",r="number"==typeof s?C(s):s;for(let e=0;e<n.length;e++){const t=n[e];if("drum"===t.type||"rest"===t.type)continue;let s=Y(t.name,g);const r=s.slice(-1),i=s.slice(0,-1)+"/"+r,l=(void 0!==t.velocity&&null!==t.velocity&&t.velocity,1);+r>3?o.push({key:i,opacity:l}):a.push({key:i,opacity:l})}w.push({ups:o,duration:r}),D.push({downs:a,duration:r})}const S=w.map(e=>{let t;if(e.ups.length>0)t=new f({keys:e.ups.map(e=>e.key),duration:e.duration}),t.setLedgerLineStyle({strokeStyle:l}),e.ups.forEach((e,n)=>{t.setKeyStyle(n,{fillStyle:`rgba(${F(c)}, ${e.opacity})`,strokeStyle:`rgba(${F(c)}, ${e.opacity})`})});else{const n=("string"==typeof e.duration?e.duration.replace(/[^a-z]/g,""):"q")+"r";t=new f({keys:["B/4"],duration:n}),t.setKeyStyle(0,{fillStyle:"transparent",strokeStyle:"transparent"})}return t.autoStem(),t}),B=(new v).setMode(v.Mode.SOFT).addTickables(S);_.applyAccidentals([B],g),y.FormatAndDraw(x,E,S);const M=new b(-16,90,h+15);M.setEndBarType(0),M.setContext(x).draw();const T=D.map(e=>{let t;if(e.downs.length>0)t=new f({keys:e.downs.map(e=>e.key),duration:e.duration,stem_direction:-1,clef:"bass"}),t.setLedgerLineStyle({strokeStyle:l}),e.downs.forEach((e,n)=>{t.setKeyStyle(n,{fillStyle:`rgba(${F(c)}, ${e.opacity})`,strokeStyle:`rgba(${F(c)}, ${e.opacity})`})});else{const n=("string"==typeof e.duration?e.duration.replace(/[^a-z]/g,""):"q")+"r";t=new f({keys:["D/3"],duration:n,stem_direction:-1,clef:"bass"}),t.setKeyStyle(0,{fillStyle:"transparent",strokeStyle:"transparent"})}return t.autoStem(),t}),G=(new v).setMode(v.Mode.SOFT).addTickables(T);function F(e){e=e.replace("#","");return`${parseInt(e.substring(0,2),16)}, ${parseInt(e.substring(2,4),16)}, ${parseInt(e.substring(4,6),16)}`}_.applyAccidentals([G],g),y.FormatAndDraw(x,M,T)}var ee;function te(){!0!==S&&!G&&ee&&ee.forEach(e=>{"rest"!==e.type&&e.synth.triggerRelease(e.name)});const e=g[M];let t=((ee=e)||[]).filter(e=>"drum"!==e.type&&"rest"!==e.type);t=t.map(e=>e.name),function(e){const t=function(e){const{Chord:t,Note:n}=Tonal,o=function(e){return[...new Set(e)]}(e.map(N));if(o.length<3)return{sortedNotes:o};const a=o.map(n.simplify).sort(n.sort),s=t.detect(a);if(0===s.length)return{sortedNotes:a};const r={"":10,M:10,m:9,7:8,maj7:7,m7:6,dim:5,aug:4,sus4:3,sus2:2,"7sus4":1,6:1,5:1};let i=null,l=0;for(let e of s){const[n]=t.tokenize(e),o=r[n]||0;o>l?(l=o,i=e):i=s[0]}i=s[0];const[c,d]=t.tokenize(i);return`${c} ${d} ${a}`}(e);if(t&&t.sortedNotes)return void"";const[,n,o]=t.split(" ");V[n]?(K.innerHTML=""+V[n].label,""+V[n].label,""+n):(K.innerHTML=n+"和弦",""+n,console.log(n,o,"未知和弦"));(function(e){return V[e]?V[e].background:"#eeeeee"})(n)}(t),e.forEach(e=>{"rest"!==e.type&&(!1!==d[e.instrument]?function(e){if(!0===S)return;if("rest"===e.type)return;let t=1.1;"bass"===e.instrument_family&&(t=1.2);const n=Math.min(e.velocity*t,.6);G?e.synth.triggerAttackRelease(e.name,e.duration,Tone.now(),n):e.synth.triggerAttack(e.name,Tone.now(),n)}(e):console.log(d[e.instrument],e.instrument))}),function(e){e=[...new Set(e)];const t=Date.now();t-m<50||(e.forEach(e=>{const t=l[e];if(!t)return;t.dom.innerHTML="";const n=t.index.incrementDecrement();t.dom.appendChild(t.imgs[n])}),m=t)}(ee.map(e=>e.instrument)),D[T]&&(D[T].style.opacity=1,A[T]&&(A[T].style.opacity=1)),M===g.length-1?M=0:M++}}({playBtn:document.getElementById("playBtn"),scoreContainer:document.getElementById("scoreContainer"),mid:e})}),window.onload=function(){Tone.context.resume().then(()=>{Tone.Transport.start(),Tone.getContext().lookAhead=0})};const V={"":{background:"#f2d6a0",text:"#2b2b2b",label:"大三和弦"},M:{background:"#f2d6a0",text:"#2b2b2b",label:"大三和弦"},maj7:{background:"#f6e0c5",text:"#2b2b2b",label:"大七和弦"},Madd9:{background:"#f3e7c2",text:"#2b2b2b",label:"大三和弦九度"},maj9:{background:"#fdf0c4",text:"#2b2b2b",label:"大九和弦"},maj13:{background:"#fdf0c4",text:"#2b2b2b",label:"大十三和弦"},Maddb9:{background:"#f5d8b3",text:"#2b2b2b",label:"大和弦加减九度"},M7sus4:{background:"#f6e0c5",text:"#2b2b2b",label:"大七挂四和弦"},M7b5:{background:"#e6d0c4",text:"#2b2b2b",label:"大七减五和弦"},"M#5add9":{background:"#f3dbab",text:"#2b2b2b",label:"增五加九大和弦"},m:{background:"#d3e7f2",text:"#1f1f1f",label:"小三和弦"},m6:{background:"#cdeee0",text:"#1f1f1f",label:"小六和弦"},m7:{background:"#c0e3ea",text:"#1f1f1f",label:"小七和弦"},m9:{background:"#d4eff0",text:"#1f1f1f",label:"小九和弦"},m11:{background:"#c2eee6",text:"#1f1f1f",label:"小十一和弦"},m13:{background:"#c2f0d2",text:"#1f1f1f",label:"小十三和弦"},madd9:{background:"#d2f1f4",text:"#1f1f1f",label:"小三和弦加九度"},madd4:{background:"#e6f7d4",text:"#1f1f1f",label:"小四度加和弦"},mM7:{background:"#b8d8ee",text:"#1f1f1f",label:"小大七和弦"},m7b5:{background:"#badcf2",text:"#1f1f1f",label:"半减七和弦"},m9b5:{background:"#badcf2",text:"#1f1f1f",label:"小九减五和弦"},mb6b9:{background:"#dcf6dc",text:"#1f1f1f",label:"小和弦加六减九度"},"m#5":{background:"#d6def8",text:"#1f1f1f",label:"增五度小和弦"},"m7#5":{background:"#ddd0ef",text:"#1f1f1f",label:"小七增五和弦"},m7add11:{background:"#c0e3ea",text:"#1f1f1f",label:"小七加十一和弦"},7:{background:"#c5f0eb",text:"#1f1f1f",label:"属七和弦"},dom7:{background:"#c5f0eb",text:"#1f1f1f",label:"属七和弦"},dom9:{background:"#c3ebe6",text:"#1f1f1f",label:"属九和弦"},9:{background:"#b1eee7",text:"#1f1f1f",label:"九和弦"},13:{background:"#d0f6d3",text:"#1f1f1f",label:"十三和弦"},11:{background:"#cce8ea",text:"#1f1f1f",label:"十一和弦"},"9no5":{background:"#d8e2e8",text:"#1f1f1f",label:"去五度九和弦"},"7no5":{background:"#d8e2e8",text:"#1f1f1f",label:"去五度七和弦"},"7add6":{background:"#c0e3ea",text:"#1f1f1f",label:"加六和弦"},"7sus4":{background:"#b1e3ef",text:"#1f1f1f",label:"四级挂七和弦"},aug:{background:"#f0d2eb",text:"#2b2b2b",label:"增三和弦"},aug7:{background:"#f7c8d4",text:"#2b2b2b",label:"增七和弦"},augmaj7:{background:"#f7c8d4",text:"#2b2b2b",label:"增大七和弦"},"7#5sus4":{background:"#e8cdf4",text:"#2b2b2b",label:"增五度挂四七和弦"},"7#5#9":{background:"#f7cccc",text:"#2b2b2b",label:"增五增九属七和弦"},dim:{background:"#d4dde4",text:"#1f1f1f",label:"减三和弦"},dim7:{background:"#e2e7eb",text:"#1f1f1f",label:"减七和弦"},dim9:{background:"#cbd7f0",text:"#1f1f1f",label:"减九和弦"},Mb5:{background:"#d4dde4",text:"#1f1f1f",label:"小减五和弦"},"9b5":{background:"#e2e7eb",text:"#1f1f1f",label:"九减五和弦"},sus2:{background:"#c4f2f8",text:"#1a2a2a",label:"挂二和弦"},sus4:{background:"#a3e3ef",text:"#1a2a2a",label:"挂四和弦"},sus:{background:"#a3e3ef",text:"#1a2a2a",label:"挂和弦"},4:{background:"#a3e3ef",text:"#1a2a2a",label:"挂四和弦"},sus24:{background:"#94ddef",text:"#1a2a2a",label:"挂二四和弦"},M9sus4:{background:"#c4f2f8",text:"#1a2a2a",label:"大九挂四和弦"},5:{background:"#b0bec5",text:"#212121",label:"五和弦"},power:{background:"#b0bec5",text:"#212121",label:"动力和弦"}};const K=document.getElementById("chord-name")}});